<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>INET Framework for OMNeT++/OMNEST: TCP Class Reference</title>
<link href="opp.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.0 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>TCP Class Reference</h1><code>#include &lt;TCP.h&gt;</code>
<p>
<a href="class_t_c_p-members.html">List of all members.</a><hr><a name="_details"></a><h2>Detailed Description</h2>
Implements the TCP protocol. This section describes the internal architecture of the TCP model.<p>
Usage and compliance with various RFCs are discussed in the corresponding NED documentation for TCP. Also, you may want to check the <a class="el" href="class_t_c_p_socket.html">TCPSocket</a> class which makes it easier to use TCP from applications.<p>
The TCP protocol implementation is composed of several classes (discussion follows below):<ul>
<li>TCP: the module class</li><li><a class="el" href="class_t_c_p_connection.html">TCPConnection</a>: manages a connection</li><li><a class="el" href="class_t_c_p_send_queue.html">TCPSendQueue</a>, <a class="el" href="class_t_c_p_receive_queue.html">TCPReceiveQueue</a>: abstract base classes for various types of send and receive queues</li><li><a class="el" href="class_t_c_p_virtual_data_send_queue.html">TCPVirtualDataSendQueue</a> and <a class="el" href="class_t_c_p_virtual_data_rcv_queue.html">TCPVirtualDataRcvQueue</a> which implement queues with "virtual" bytes (byte counts only)</li><li><a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a>: abstract base class for TCP algorithms, and subclasses: <a class="el" href="class_dumb_t_c_p.html">DumbTCP</a>, <a class="el" href="class_t_c_p_base_alg.html">TCPBaseAlg</a>, <a class="el" href="class_t_c_p_tahoe_reno_family.html">TCPTahoeRenoFamily</a>, <a class="el" href="class_t_c_p_tahoe.html">TCPTahoe</a>, <a class="el" href="class_t_c_p_reno.html">TCPReno</a>.</li></ul>
<p>
TCP subclassed from cSimpleModule. It manages socketpair-to-connection mapping, and dispatches segments and user commands to the appropriate <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> object.<p>
<a class="el" href="class_t_c_p_connection.html">TCPConnection</a> manages the connection, with the help of other objects. <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> itself implements the basic TCP "machinery": takes care of the state machine, stores the state variables (TCB), sends/receives SYN, FIN, RST, ACKs, etc.<p>
<a class="el" href="class_t_c_p_connection.html">TCPConnection</a> internally relies on 3 objects. The first two are subclassed from <a class="el" href="class_t_c_p_send_queue.html">TCPSendQueue</a> and <a class="el" href="class_t_c_p_receive_queue.html">TCPReceiveQueue</a>. They manage the actual data stream, so <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> itself only works with sequence number variables. This makes it possible to easily accomodate need for various types of simulated data transfer: real byte stream, "virtual" bytes (byte counts only), and sequence of cMessage objects (where every message object is mapped to a TCP sequence number range).<p>
Currently implemented send queue and receive queue classes are <a class="el" href="class_t_c_p_virtual_data_send_queue.html">TCPVirtualDataSendQueue</a> and <a class="el" href="class_t_c_p_virtual_data_rcv_queue.html">TCPVirtualDataRcvQueue</a> which implement queues with "virtual" bytes (byte counts only).<p>
The third object is subclassed from <a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a>. Control over retransmissions, congestion control and ACK sending are "outsourced" from <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> into <a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a>: delayed acks, slow start, fast rexmit, etc. are all implemented in <a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a> subclasses. This simplifies the design of <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> and makes it a lot easier to implement new TCP variations such as NewReno, Vegas or LinuxTCP as <a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a> subclasses.<p>
Currently implemented <a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a> classes are <a class="el" href="class_dumb_t_c_p.html">DumbTCP</a>, <a class="el" href="class_t_c_p_tahoe.html">TCPTahoe</a>, <a class="el" href="class_t_c_p_reno.html">TCPReno</a>, etc.<p>
The concrete <a class="el" href="class_t_c_p_algorithm.html">TCPAlgorithm</a> class to use can be chosen per connection (in OPEN) or in a module parameter. 
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#a0">TCP</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#a1">~TCP</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#a2">addSockPair</a> (<a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *conn, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> localAddr, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> remoteAddr, int localPort, int remotePort)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#a3">updateSockPair</a> (<a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *conn, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> localAddr, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> remoteAddr, int localPort, int remotePort)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#a4">addForkedConnection</a> (<a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *conn, <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *newConn, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> localAddr, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> remoteAddr, int localPort, int remotePort)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#a5">getEphemeralPort</a> ()</td></tr>

<tr><td colspan="2"><br><h2>Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#o0">recordStatistics</a></td></tr>

<tr><td colspan="2"><br><h2>Static Public Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#s0">testing</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#s1">logverbose</a></td></tr>

<tr><td colspan="2"><br><h2>Protected Types</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">typedef std::map&lt; <a class="el" href="struct_t_c_p_1_1_app_conn_key.html">AppConnKey</a>,<br>
 <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> * &gt;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#x0">TcpAppConnMap</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">typedef std::map&lt; <a class="el" href="struct_t_c_p_1_1_sock_pair.html">SockPair</a>,<br>
 <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> * &gt;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#x1">TcpConnMap</a></td></tr>

<tr><td colspan="2"><br><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b0">findConnForSegment</a> (<a class="el" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="el" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b1">findConnForApp</a> (int appGateIndex, int connId)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b2">removeConnection</a> (<a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *conn)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b3">updateDisplayString</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b4">initialize</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b5">handleMessage</a> (cMessage *msg)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#b6">finish</a> ()</td></tr>

<tr><td colspan="2"><br><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_t_c_p.html#x0">TcpAppConnMap</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#p0">tcpAppConnMap</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_t_c_p.html#x1">TcpConnMap</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#p1">tcpConnMap</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#p2">lastEphemeralPort</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">std::multiset&lt; short &gt;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_c_p.html#p3">usedEphemeralPorts</a></td></tr>

<tr><td colspan="2"><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_t_c_p_1_1_app_conn_key.html">AppConnKey</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_t_c_p_1_1_sock_pair.html">SockPair</a></td></tr>

</table>
<hr><h2>Member Typedef Documentation</h2>
<a class="anchor" name="x0" doxytag="TCP::TcpAppConnMap"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">typedef std::map&lt;<a class="el" href="struct_t_c_p_1_1_app_conn_key.html">AppConnKey</a>,<a class="el" href="class_t_c_p_connection.html">TCPConnection</a>*&gt; <a class="el" href="class_t_c_p.html#x0">TCP::TcpAppConnMap</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="x1" doxytag="TCP::TcpConnMap"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">typedef std::map&lt;<a class="el" href="struct_t_c_p_1_1_sock_pair.html">SockPair</a>,<a class="el" href="class_t_c_p_connection.html">TCPConnection</a>*&gt; <a class="el" href="class_t_c_p.html#x1">TCP::TcpConnMap</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="a0" doxytag="TCP::TCP"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">TCP::TCP           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00159 {}
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="TCP::~TCP"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">TCP::~<a class="el" href="class_t_c_p.html">TCP</a>           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00075 {
00076     <span class="keywordflow">while</span> (!<a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.empty())
00077     {
00078         TcpAppConnMap::iterator i = <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.begin();
00079         <span class="keyword">delete</span> (*i).second;
00080         <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.erase(i);
00081     }
00082 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="a4" doxytag="TCP::addForkedConnection"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::addForkedConnection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>newConn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>localAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>remoteAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>localPort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>remotePort</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Update conn's socket pair, and register newConn (which'll keep LISTENing). Also, conn will get a new connId (and newConn will live on with its old connId). <div class="fragment"><pre class="fragment">00348 {
00349     <span class="comment">// update conn's socket pair, and register newConn (which'll keep LISTENing)</span>
00350     <a class="code" href="class_t_c_p.html#a3">updateSockPair</a>(conn, localAddr, remoteAddr, localPort, remotePort);
00351     <a class="code" href="class_t_c_p.html#a2">addSockPair</a>(newConn, newConn-&gt;<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a>, newConn-&gt;<a class="code" href="class_t_c_p_connection.html#o3">remoteAddr</a>, newConn-&gt;<a class="code" href="class_t_c_p_connection.html#o4">localPort</a>, newConn-&gt;<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a>);
00352 
00353     <span class="comment">// conn will get a new connId...</span>
00354     AppConnKey key;
00355     key.appGateIndex = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o0">appGateIndex</a>;
00356     key.<a class="code" href="class_t_c_p_connection.html#o1">connId</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o1">connId</a>;
00357     <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.erase(key);
00358     key.<a class="code" href="class_t_c_p_connection.html#o1">connId</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o1">connId</a> = ev.getUniqueNumber();
00359     <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>[key] = conn;
00360 
00361     <span class="comment">// ...and newConn will live on with the old connId</span>
00362     key.<a class="code" href="class_t_c_p_connection.html#o0">appGateIndex</a> = newConn-&gt;<a class="code" href="class_t_c_p_connection.html#o0">appGateIndex</a>;
00363     key.<a class="code" href="class_t_c_p_connection.html#o1">connId</a> = newConn-&gt;<a class="code" href="class_t_c_p_connection.html#o1">connId</a>;
00364     <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>[key] = newConn;
00365 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="TCP::addSockPair"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::addSockPair           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>localAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>remoteAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>localPort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>remotePort</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
To be called from <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> when a new connection gets created, during processing of OPEN_ACTIVE or OPEN_PASSIVE. <div class="fragment"><pre class="fragment">00294 {
00295     <span class="comment">// update addresses/ports in TCPConnection</span>
00296     SockPair key;
00297     key.localAddr = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a> = localAddr;
00298     key.remoteAddr = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o3">remoteAddr</a> = remoteAddr;
00299     key.localPort = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o4">localPort</a> = localPort;
00300     key.<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a> = remotePort;
00301 
00302     <span class="comment">// make sure connection is unique</span>
00303     TcpConnMap::iterator it = <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.find(key);
00304     <span class="keywordflow">if</span> (it!=<a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.end())
00305     {
00306         <span class="comment">// throw "address already in use" error</span>
00307         <span class="keywordflow">if</span> (remoteAddr.<a class="code" href="class_i_pv_x_address.html#z36_0">isUnspecified</a>() &amp;&amp; remotePort==-1)
00308             error(<span class="stringliteral">"Address already in use: there is already a connection listening on %s:%d"</span>,
00309                   localAddr.<a class="code" href="class_i_pv_x_address.html#z35_11">str</a>().c_str(), localPort);
00310         <span class="keywordflow">else</span>
00311             error(<span class="stringliteral">"Address already in use: there is already a connection %s:%d to %s:%d"</span>,
00312                   localAddr.<a class="code" href="class_i_pv_x_address.html#z35_11">str</a>().c_str(), localPort, remoteAddr.<a class="code" href="class_i_pv_x_address.html#z35_11">str</a>().c_str(), remotePort);
00313     }
00314 
00315     <span class="comment">// then insert it into tcpConnMap</span>
00316     <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>[key] = conn;
00317 
00318     <span class="comment">// mark port as used</span>
00319     <span class="keywordflow">if</span> (localPort&gt;=EPHEMERAL_PORTRANGE_START &amp;&amp; localPort&lt;EPHEMERAL_PORTRANGE_END)
00320         usedEphemeralPorts.insert(localPort);
00321 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b1" doxytag="TCP::findConnForApp"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> * TCP::findConnForApp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>appGateIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>connId</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00264 {
00265     AppConnKey key;
00266     key.appGateIndex = appGateIndex;
00267     key.connId = connId;
00268 
00269     TcpAppConnMap::iterator i = <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.find(key);
00270     <span class="keywordflow">return</span> i==<a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.end() ? NULL : i-&gt;second;
00271 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b0" doxytag="TCP::findConnForSegment"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> * TCP::findConnForSegment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_segment.html">TCPSegment</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>tcpseg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>srcAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>destAddr</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00225 {
00226     SockPair key;
00227     key.localAddr = destAddr;
00228     key.remoteAddr = srcAddr;
00229     key.localPort = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a6">destPort</a>();
00230     key.remotePort = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a4">srcPort</a>();
00231     SockPair save = key;
00232 
00233     <span class="comment">// try with fully qualified SockPair</span>
00234     TcpConnMap::iterator i;
00235     i = <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.find(key);
00236     <span class="keywordflow">if</span> (i!=<a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.end())
00237         <span class="keywordflow">return</span> i-&gt;second;
00238 
00239     <span class="comment">// try with localAddr missing (only localPort specified in passive/active open)</span>
00240     key.localAddr = <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a>();
00241     i = <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.find(key);
00242     <span class="keywordflow">if</span> (i!=<a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.end())
00243         <span class="keywordflow">return</span> i-&gt;second;
00244 
00245     <span class="comment">// try fully qualified local socket + blank remote socket (for incoming SYN)</span>
00246     key = save;
00247     key.remoteAddr = <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a>();
00248     key.remotePort = -1;
00249     i = <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.find(key);
00250     <span class="keywordflow">if</span> (i!=<a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.end())
00251         <span class="keywordflow">return</span> i-&gt;second;
00252 
00253     <span class="comment">// try with blank remote socket, and localAddr missing (for incoming SYN)</span>
00254     key.localAddr = <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a>();
00255     i = <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.find(key);
00256     <span class="keywordflow">if</span> (i!=<a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.end())
00257         <span class="keywordflow">return</span> i-&gt;second;
00258 
00259     <span class="comment">// given up</span>
00260     <span class="keywordflow">return</span> NULL;
00261 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b6" doxytag="TCP::finish"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::finish           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00393 {
00394     <a class="code" href="_t_c_p_8h.html#a0">tcpEV</a> &lt;&lt; fullPath() &lt;&lt; <span class="stringliteral">": finishing with "</span> &lt;&lt; <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.size() &lt;&lt; <span class="stringliteral">" connections open.\n"</span>;
00395 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="TCP::getEphemeralPort"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">short TCP::getEphemeralPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
To be called from <a class="el" href="class_t_c_p_connection.html">TCPConnection</a>: reserves an ephemeral port for the connection. <div class="fragment"><pre class="fragment">00274 {
00275     <span class="comment">// start at the last allocated port number + 1, and search for an unused one</span>
00276     <span class="keywordtype">short</span> searchUntil = <a class="code" href="class_t_c_p.html#p2">lastEphemeralPort</a>++;
00277     <span class="keywordflow">if</span> (lastEphemeralPort == EPHEMERAL_PORTRANGE_END) <span class="comment">// wrap</span>
00278         lastEphemeralPort = EPHEMERAL_PORTRANGE_START;
00279 
00280     while (usedEphemeralPorts.find(lastEphemeralPort)!=usedEphemeralPorts.end())
00281     {
00282         <span class="keywordflow">if</span> (lastEphemeralPort == searchUntil) <span class="comment">// got back to starting point?</span>
00283             error("Ephemeral port range %d..%d exhausted, all ports occupied", EPHEMERAL_PORTRANGE_START, EPHEMERAL_PORTRANGE_END);
00284         lastEphemeralPort++;
00285         if (lastEphemeralPort == EPHEMERAL_PORTRANGE_END) <span class="comment">// wrap</span>
00286             lastEphemeralPort = EPHEMERAL_PORTRANGE_START;
00287     }
00288 
00289     <span class="comment">// found a free one, return it</span>
00290     return lastEphemeralPort;
00291 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b5" doxytag="TCP::handleMessage"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::handleMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00086 {
00087     <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
00088     {
00089         <a class="code" href="class_t_c_p_connection.html">TCPConnection</a> *conn = (<a class="code" href="class_t_c_p_connection.html">TCPConnection</a> *) msg-&gt;contextPointer();
00090         <span class="keywordtype">bool</span> ret = conn-&gt;<a class="code" href="class_t_c_p_connection.html#a15">processTimer</a>(msg);
00091         <span class="keywordflow">if</span> (!ret)
00092             removeConnection(conn);
00093     }
00094     else if (msg-&gt;arrivedOn("from_ip") || msg-&gt;arrivedOn("from_ipv6"))
00095     {
00096         <span class="keywordflow">if</span> (dynamic_cast&lt;ICMPMessage *&gt;(msg) || dynamic_cast&lt;ICMPv6Message *&gt;(msg))
00097         {
00098             <a class="code" href="_t_c_p_8h.html#a0">tcpEV</a> &lt;&lt; <span class="stringliteral">"ICMP error received -- discarding\n"</span>; <span class="comment">// FIXME can ICMP packets really make it up to TCP???</span>
00099             <span class="keyword">delete</span> msg;
00100         }
00101         <span class="keywordflow">else</span>
00102         {
00103             <span class="comment">// must be a TCPSegment</span>
00104             <a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg = check_and_cast&lt;TCPSegment *&gt;(msg);
00105 
00106             <span class="comment">// get src/dest addresses</span>
00107             <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, destAddr;
00108             <span class="keywordflow">if</span> (dynamic_cast&lt;IPControlInfo *&gt;(tcpseg-&gt;controlInfo())!=NULL)
00109             {
00110                 <a class="code" href="class_i_p_control_info.html">IPControlInfo</a> *controlInfo = (<a class="code" href="class_i_p_control_info.html">IPControlInfo</a> *)tcpseg-&gt;removeControlInfo();
00111                 srcAddr = controlInfo-&gt;<a class="code" href="class_i_p_control_info___base.html#a6">srcAddr</a>();
00112                 destAddr = controlInfo-&gt;<a class="code" href="class_i_p_control_info___base.html#a3">destAddr</a>();
00113                 <span class="keyword">delete</span> controlInfo;
00114             }
00115             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dynamic_cast&lt;IPv6ControlInfo *&gt;(tcpseg-&gt;controlInfo())!=NULL)
00116             {
00117                 <a class="code" href="class_i_pv6_control_info.html">IPv6ControlInfo</a> *controlInfo = (<a class="code" href="class_i_pv6_control_info.html">IPv6ControlInfo</a> *)tcpseg-&gt;removeControlInfo();
00118                 srcAddr = controlInfo-&gt;<a class="code" href="class_i_pv6_control_info___base.html#a8">srcAddr</a>();
00119                 destAddr = controlInfo-&gt;<a class="code" href="class_i_pv6_control_info___base.html#a5">destAddr</a>();
00120                 <span class="keyword">delete</span> controlInfo;
00121             }
00122             <span class="keywordflow">else</span>
00123             {
00124                 error(<span class="stringliteral">"(%s)%s arrived without control info"</span>, tcpseg-&gt;className(), tcpseg-&gt;name());
00125             }
00126 
00127             <span class="comment">// process segment</span>
00128             <a class="code" href="class_t_c_p_connection.html">TCPConnection</a> *conn = <a class="code" href="class_t_c_p.html#b0">findConnForSegment</a>(tcpseg, srcAddr, destAddr);
00129             <span class="keywordflow">if</span> (!conn)
00130             {
00131                 <a class="code" href="class_t_c_p_connection.html#e6">TCPConnection::segmentArrivalWhileClosed</a>(tcpseg, srcAddr, destAddr);
00132                 <span class="keyword">delete</span> tcpseg;
00133                 <span class="keywordflow">return</span>;
00134             }
00135             <span class="keywordtype">bool</span> ret = conn-&gt;<a class="code" href="class_t_c_p_connection.html#a16">processTCPSegment</a>(tcpseg, srcAddr, destAddr);
00136             <span class="keywordflow">if</span> (!ret)
00137                 removeConnection(conn);
00138         }
00139     }
00140     else <span class="comment">// must be from app</span>
00141     {
00142         <a class="code" href="class_t_c_p_command.html">TCPCommand</a> *controlInfo = check_and_cast&lt;TCPCommand *&gt;(msg-&gt;controlInfo());
00143         <span class="keywordtype">int</span> appGateIndex = msg-&gt;arrivalGate()-&gt;index();
00144         <span class="keywordtype">int</span> connId = controlInfo-&gt;<a class="code" href="class_t_c_p_command.html#a6">connId</a>();
00145 
00146         <a class="code" href="class_t_c_p_connection.html">TCPConnection</a> *conn = <a class="code" href="class_t_c_p.html#b1">findConnForApp</a>(appGateIndex, connId);
00147 
00148         <span class="keywordflow">if</span> (!conn)
00149         {
00150             conn = <span class="keyword">new</span> <a class="code" href="class_t_c_p_connection.html">TCPConnection</a>(<span class="keyword">this</span>,appGateIndex,connId);
00151 
00152             <span class="comment">// add into appConnMap here; it'll be added to connMap during processing</span>
00153             <span class="comment">// the OPEN command in TCPConnection's processAppCommand().</span>
00154             AppConnKey key;
00155             key.<a class="code" href="class_t_c_p_connection.html#o0">appGateIndex</a> = appGateIndex;
00156             key.<a class="code" href="class_t_c_p_connection.html#o1">connId</a> = connId;
00157             <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>[key] = conn;
00158 
00159             <a class="code" href="_t_c_p_8h.html#a0">tcpEV</a> &lt;&lt; <span class="stringliteral">"TCP connection created for "</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">"\n"</span>;
00160         }
00161         <span class="keywordtype">bool</span> ret = conn-&gt;<a class="code" href="class_t_c_p_connection.html#a17">processAppCommand</a>(msg);
00162         <span class="keywordflow">if</span> (!ret)
00163             removeConnection(conn);
00164     }
00165 
00166     if (ev.isGUI())
00167         updateDisplayString();
00168 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b4" doxytag="TCP::initialize"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::initialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00060 {
00061     <a class="code" href="class_t_c_p.html#p2">lastEphemeralPort</a> = <a class="code" href="_t_c_p_8cc.html#a0">EPHEMERAL_PORTRANGE_START</a>;
00062     WATCH(lastEphemeralPort);
00063 
00064     WATCH_PTRMAP(tcpConnMap);
00065     WATCH_PTRMAP(tcpAppConnMap);
00066 
00067     <a class="code" href="class_t_c_p.html#o0">recordStatistics</a> = par(<span class="stringliteral">"recordStats"</span>);
00068 
00069     cModule *netw = simulation.systemModule();
00070     <a class="code" href="class_t_c_p.html#s0">testing</a> = netw-&gt;hasPar(<span class="stringliteral">"testing"</span>) &amp;&amp; netw-&gt;par(<span class="stringliteral">"testing"</span>).boolValue();
00071     <a class="code" href="class_t_c_p.html#s1">logverbose</a> = !<a class="code" href="class_t_c_p.html#s0">testing</a> &amp;&amp; netw-&gt;hasPar(<span class="stringliteral">"logverbose"</span>) &amp;&amp; netw-&gt;par(<span class="stringliteral">"logverbose"</span>).boolValue();
00072 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b2" doxytag="TCP::removeConnection"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::removeConnection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>conn</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00368 {
00369     <a class="code" href="_t_c_p_8h.html#a0">tcpEV</a> &lt;&lt; <span class="stringliteral">"Deleting TCP connection\n"</span>;
00370 
00371     AppConnKey key;
00372     key.appGateIndex = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o0">appGateIndex</a>;
00373     key.<a class="code" href="class_t_c_p_connection.html#o1">connId</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o1">connId</a>;
00374     <a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.erase(key);
00375 
00376     SockPair key2;
00377     key2.<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a>;
00378     key2.remoteAddr = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o3">remoteAddr</a>;
00379     key2.localPort = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o4">localPort</a>;
00380     key2.<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a>;
00381     <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.erase(key2);
00382 
00383     <span class="comment">// IMPORTANT: usedEphemeralPorts.erase(conn-&gt;localPort) is NOT GOOD because it</span>
00384     <span class="comment">// deletes ALL occurrences of the port from the multiset.</span>
00385     std::multiset&lt;short&gt;::iterator it = <a class="code" href="class_t_c_p.html#p3">usedEphemeralPorts</a>.find(conn-&gt;<a class="code" href="class_t_c_p_connection.html#o4">localPort</a>);
00386     <span class="keywordflow">if</span> (it!=<a class="code" href="class_t_c_p.html#p3">usedEphemeralPorts</a>.end())
00387         <a class="code" href="class_t_c_p.html#p3">usedEphemeralPorts</a>.erase(it);
00388 
00389     <span class="keyword">delete</span> conn;
00390 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b3" doxytag="TCP::updateDisplayString"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::updateDisplayString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00171 {
00172     <span class="keywordflow">if</span> (ev.disabled())
00173     {
00174         <span class="comment">// in express mode, we don't bother to update the display</span>
00175         <span class="comment">// (std::map's iteration is not very fast if map is large)</span>
00176         displayString().setTagArg(<span class="stringliteral">"t"</span>,0,<span class="stringliteral">""</span>);
00177         <span class="keywordflow">return</span>;
00178     }
00179 
00180     <span class="comment">//char buf[40];</span>
00181     <span class="comment">//sprintf(buf,"%d conns", tcpAppConnMap.size());</span>
00182     <span class="comment">//displayString().setTagArg("t",0,buf);</span>
00183 
00184     <span class="keywordtype">int</span> numINIT=0, numCLOSED=0, numLISTEN=0, numSYN_SENT=0, numSYN_RCVD=0,
00185         numESTABLISHED=0, numCLOSE_WAIT=0, numLAST_ACK=0, numFIN_WAIT_1=0,
00186         numFIN_WAIT_2=0, numCLOSING=0, numTIME_WAIT=0;
00187 
00188     <span class="keywordflow">for</span> (TcpAppConnMap::iterator i=<a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.begin(); i!=<a class="code" href="class_t_c_p.html#p0">tcpAppConnMap</a>.end(); ++i)
00189     {
00190         <span class="keywordtype">int</span> state = (*i).second-&gt;getFsmState();
00191         <span class="keywordflow">switch</span>(state)
00192         {
00193            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a6">TCP_S_INIT</a>:        numINIT++; <span class="keywordflow">break</span>;
00194            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a7">TCP_S_CLOSED</a>:      numCLOSED++; <span class="keywordflow">break</span>;
00195            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a8">TCP_S_LISTEN</a>:      numLISTEN++; <span class="keywordflow">break</span>;
00196            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a9">TCP_S_SYN_SENT</a>:    numSYN_SENT++; <span class="keywordflow">break</span>;
00197            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a10">TCP_S_SYN_RCVD</a>:    numSYN_RCVD++; <span class="keywordflow">break</span>;
00198            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a11">TCP_S_ESTABLISHED</a>: numESTABLISHED++; <span class="keywordflow">break</span>;
00199            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a12">TCP_S_CLOSE_WAIT</a>:  numCLOSE_WAIT++; <span class="keywordflow">break</span>;
00200            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a13">TCP_S_LAST_ACK</a>:    numLAST_ACK++; <span class="keywordflow">break</span>;
00201            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a14">TCP_S_FIN_WAIT_1</a>:  numFIN_WAIT_1++; <span class="keywordflow">break</span>;
00202            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a15">TCP_S_FIN_WAIT_2</a>:  numFIN_WAIT_2++; <span class="keywordflow">break</span>;
00203            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a16">TCP_S_CLOSING</a>:     numCLOSING++; <span class="keywordflow">break</span>;
00204            <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a40a17">TCP_S_TIME_WAIT</a>:   numTIME_WAIT++; <span class="keywordflow">break</span>;
00205         }
00206     }
00207     <span class="keywordtype">char</span> buf2[200];
00208     buf2[0] = <span class="charliteral">'\0'</span>;
00209     <span class="keywordflow">if</span> (numINIT&gt;0)       sprintf(buf2+strlen(buf2), "init:%d ", numINIT);
00210     if (numCLOSED&gt;0)     sprintf(buf2+strlen(buf2), "closed:%d ", numCLOSED);
00211     if (numLISTEN&gt;0)     sprintf(buf2+strlen(buf2), "listen:%d ", numLISTEN);
00212     if (numSYN_SENT&gt;0)   sprintf(buf2+strlen(buf2), "syn_sent:%d ", numSYN_SENT);
00213     if (numSYN_RCVD&gt;0)   sprintf(buf2+strlen(buf2), "syn_rcvd:%d ", numSYN_RCVD);
00214     if (numESTABLISHED&gt;0) sprintf(buf2+strlen(buf2),"estab:%d ", numESTABLISHED);
00215     if (numCLOSE_WAIT&gt;0) sprintf(buf2+strlen(buf2), "close_wait:%d ", numCLOSE_WAIT);
00216     if (numLAST_ACK&gt;0)   sprintf(buf2+strlen(buf2), "last_ack:%d ", numLAST_ACK);
00217     if (numFIN_WAIT_1&gt;0) sprintf(buf2+strlen(buf2), "fin_wait_1:%d ", numFIN_WAIT_1);
00218     if (numFIN_WAIT_2&gt;0) sprintf(buf2+strlen(buf2), "fin_wait_2:%d ", numFIN_WAIT_2);
00219     if (numCLOSING&gt;0)    sprintf(buf2+strlen(buf2), "closing:%d ", numCLOSING);
00220     if (numTIME_WAIT&gt;0)  sprintf(buf2+strlen(buf2), "time_wait:%d ", numTIME_WAIT);
00221     displayString().setTagArg("t",0,buf2);
00222 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="TCP::updateSockPair"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void TCP::updateSockPair           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p_connection.html">TCPConnection</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>conn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>localAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_pv_x_address.html">IPvXAddress</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>remoteAddr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>localPort</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>remotePort</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
To be called from <a class="el" href="class_t_c_p_connection.html">TCPConnection</a> when socket pair (key for TcpConnMap) changes (e.g. becomes fully qualified). <div class="fragment"><pre class="fragment">00324 {
00325     <span class="comment">// find with existing address/port pair...</span>
00326     SockPair key;
00327     key.localAddr = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a>;
00328     key.remoteAddr = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o3">remoteAddr</a>;
00329     key.localPort = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o4">localPort</a>;
00330     key.<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a>;
00331     TcpConnMap::iterator it = <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.find(key);
00332     ASSERT(it!=<a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.end() &amp;&amp; it-&gt;second==conn);
00333 
00334     <span class="comment">// ...and remove from the old place in tcpConnMap</span>
00335     <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>.erase(it);
00336 
00337     <span class="comment">// then update addresses/ports, and re-insert it with new key into tcpConnMap</span>
00338     key.<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a> = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o2">localAddr</a> = localAddr;
00339     key.remoteAddr = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o3">remoteAddr</a> = remoteAddr;
00340     ASSERT(conn-&gt;<a class="code" href="class_t_c_p_connection.html#o4">localPort</a> == localPort);
00341     key.remotePort = conn-&gt;<a class="code" href="class_t_c_p_connection.html#o5">remotePort</a> = remotePort;
00342     <a class="code" href="class_t_c_p.html#p1">tcpConnMap</a>[key] = conn;
00343 
00344     <span class="comment">// localPort doesn't change (see ASSERT above), so there's no need to update usedEphemeralPorts[].</span>
00345 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Data Documentation</h2>
<a class="anchor" name="p2" doxytag="TCP::lastEphemeralPort"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">short <a class="el" href="class_t_c_p.html#p2">TCP::lastEphemeralPort</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="s1" doxytag="TCP::logverbose"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool <a class="el" href="class_t_c_p.html#s1">TCP::logverbose</a><code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="o0" doxytag="TCP::recordStatistics"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool <a class="el" href="class_t_c_p.html#o0">TCP::recordStatistics</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p0" doxytag="TCP::tcpAppConnMap"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p.html#x0">TcpAppConnMap</a> <a class="el" href="class_t_c_p.html#p0">TCP::tcpAppConnMap</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p1" doxytag="TCP::tcpConnMap"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_t_c_p.html#x1">TcpConnMap</a> <a class="el" href="class_t_c_p.html#p1">TCP::tcpConnMap</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="s0" doxytag="TCP::testing"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool <a class="el" href="class_t_c_p.html#s0">TCP::testing</a><code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p3" doxytag="TCP::usedEphemeralPorts"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">std::multiset&lt;short&gt; <a class="el" href="class_t_c_p.html#p3">TCP::usedEphemeralPorts</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_t_c_p_8h.html">TCP.h</a><li><a class="el" href="_t_c_p_8cc.html">TCP.cc</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 18:22:30 2006 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.0 </small></address>
</body>
</html>
