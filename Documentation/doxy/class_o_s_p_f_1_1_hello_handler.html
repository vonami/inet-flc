<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>INET Framework for OMNeT++/OMNEST: OSPF::HelloHandler Class Reference</title>
<link href="opp.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.0 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="namespace_o_s_p_f.html">OSPF</a>::<a class="el" href="class_o_s_p_f_1_1_hello_handler.html">HelloHandler</a></div>
<h1>OSPF::HelloHandler Class Reference</h1><code>#include &lt;HelloHandler.h&gt;</code>
<p>
<p>Inheritance diagram for OSPF::HelloHandler:
<p><center><img src="class_o_s_p_f_1_1_hello_handler.png" usemap="#OSPF::HelloHandler_map" border="0" alt=""></center>
<map name="OSPF::HelloHandler_map">
<area href="class_o_s_p_f_1_1_i_message_handler.html" alt="OSPF::IMessageHandler" shape="rect" coords="0,0,151,24">
</map>
<a href="class_o_s_p_f_1_1_hello_handler-members.html">List of all members.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_s_p_f_1_1_hello_handler.html#a0">HelloHandler</a> (<a class="el" href="class_o_s_p_f_1_1_router.html">Router</a> *containingRouter)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_s_p_f_1_1_hello_handler.html#a1">ProcessPacket</a> (<a class="el" href="class_o_s_p_f_packet.html">OSPFPacket</a> *packet, <a class="el" href="class_o_s_p_f_1_1_interface.html">Interface</a> *intf, <a class="el" href="class_o_s_p_f_1_1_neighbor.html">Neighbor</a> *unused=NULL)</td></tr>

</table>
<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="a0" doxytag="OSPF::HelloHandler::HelloHandler"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">OSPF::HelloHandler::HelloHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_o_s_p_f_1_1_router.html">Router</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>containingRouter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00008                                                             :
00009     <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html">OSPF::IMessageHandler</a> (containingRouter)
00010 {
00011 }

</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="a1" doxytag="OSPF::HelloHandler::ProcessPacket"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void OSPF::HelloHandler::ProcessPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_o_s_p_f_packet.html">OSPFPacket</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>packet</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_o_s_p_f_1_1_interface.html">Interface</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>intf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_o_s_p_f_1_1_neighbor.html">Neighbor</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>unused</em> = <code>NULL</code></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00014 {
00015     <a class="code" href="class_o_s_p_f_hello_packet.html">OSPFHelloPacket</a>* helloPacket         = check_and_cast&lt;OSPFHelloPacket*&gt; (packet);
00016     <span class="keywordtype">bool</span>             rebuildRoutingTable = <span class="keyword">false</span>;
00017 
00018     <span class="comment">/* The values of the Network Mask, HelloInterval,</span>
00019 <span class="comment">       and RouterDeadInterval fields in the received Hello packet must</span>
00020 <span class="comment">       be checked against the values configured for the receiving</span>
00021 <span class="comment">       interface.  Any mismatch causes processing to stop and the</span>
00022 <span class="comment">       packet to be dropped.</span>
00023 <span class="comment">     */</span>
00024     <span class="keywordflow">if</span> ((intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a39">GetHelloInterval</a> () == helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a10">getHelloInterval</a> ()) &amp;&amp;
00025         (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a43">GetRouterDeadInterval</a> () == helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a17">getRouterDeadInterval</a> ()))
00026     {
00027         <a class="code" href="class_o_s_p_f_1_1_interface.html#w23">OSPF::Interface::OSPFInterfaceType</a> interfaceType = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a19">GetType</a> ();
00028         <span class="comment">/* There is one exception to the above rule: on point-to-point</span>
00029 <span class="comment">           networks and on virtual links, the Network Mask in the received</span>
00030 <span class="comment">           Hello Packet should be ignored.</span>
00031 <span class="comment">         */</span>
00032         <span class="keywordflow">if</span> (!((interfaceType != OSPF::Interface::PointToPoint) &amp;&amp;
00033               (interfaceType != OSPF::Interface::Virtual) &amp;&amp;
00034               (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a49">GetAddressRange</a> ().mask != <a class="code" href="_o_s_p_fcommon_8h.html#a54">IPv4AddressFromULong</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a7">getNetworkMask</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ()))
00035              )
00036            )
00037         {
00038             <span class="comment">/* The setting of the E-bit found in the Hello Packet's Options field must match this area's</span>
00039 <span class="comment">               ExternalRoutingCapability.</span>
00040 <span class="comment">             */</span>
00041             <span class="keywordflow">if</span> (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a59">GetArea</a> ()-&gt;GetExternalRoutingCapability () == helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a12">getOptions</a> ().<a class="code" href="struct_o_s_p_f_options.html#o1">E_ExternalRoutingCapability</a>) {
00042                 <a class="code" href="class_i_p_control_info.html">IPControlInfo</a>*      controlInfo             = check_and_cast&lt;IPControlInfo *&gt; (helloPacket-&gt;controlInfo ());
00043                 <a class="code" href="struct_o_s_p_f_1_1_i_pv4_address.html">OSPF::IPv4Address</a>   srcAddress              = <a class="code" href="_o_s_p_fcommon_8h.html#a54">IPv4AddressFromULong</a> (controlInfo-&gt;<a class="code" href="class_i_p_control_info___base.html#a6">srcAddr</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ());
00044                 <span class="keywordtype">bool</span>                neighborChanged         = <span class="keyword">false</span>;
00045                 <span class="keywordtype">bool</span>                neighborsDRStateChanged = <span class="keyword">false</span>;
00046                 <span class="keywordtype">bool</span>                drChanged               = <span class="keyword">false</span>;
00047                 <span class="keywordtype">bool</span>                backupSeen              = <span class="keyword">false</span>;
00048                 <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>*     neighbor;
00049 
00050                 <span class="comment">/* If the receiving interface connects to a broadcast, Point-to-</span>
00051 <span class="comment">                   MultiPoint or NBMA network the source is identified by the IP</span>
00052 <span class="comment">                   source address found in the Hello's IP header.</span>
00053 <span class="comment">                 */</span>
00054                 <span class="keywordflow">if</span> ((interfaceType == OSPF::Interface::Broadcast) ||
00055                     (interfaceType == OSPF::Interface::PointToMultiPoint) ||
00056                     (interfaceType == OSPF::Interface::NBMA))
00057                 {
00058                     neighbor = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7">GetNeighborByAddress</a> (srcAddress);
00059                 } <span class="keywordflow">else</span> {
00060                     <span class="comment">/* If the receiving interface connects to a point-to-point link or a virtual link,</span>
00061 <span class="comment">                       the source is identified by the Router ID found in the Hello's OSPF packet header.</span>
00062 <span class="comment">                     */</span>
00063                     neighbor = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a6">GetNeighborByID</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_packet.html#a13">getRouterID</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ());
00064                 }
00065 
00066                 <span class="keywordflow">if</span> (neighbor != NULL) {
00067                     <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#p0">router</a>-&gt;GetMessageHandler ()-&gt;PrintEvent (<span class="stringliteral">"Hello packet received"</span>, intf, neighbor);
00068 
00069                     IPv4Address                 designatedAddress   = neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a36">GetDesignatedRouter</a> ().ipInterfaceAddress;
00070                     IPv4Address                 backupAddress       = neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a38">GetBackupDesignatedRouter</a> ().ipInterfaceAddress;
00071                     <span class="keywordtype">char</span>                        newPriority         = helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a15">getRouterPriority</a> ();
00072                     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               source              = controlInfo-&gt;<a class="code" href="class_i_p_control_info___base.html#a6">srcAddr</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ();
00073                     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               newDesignatedRouter = helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a19">getDesignatedRouter</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ();
00074                     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               newBackupRouter     = helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a22">getBackupDesignatedRouter</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ();
00075                     <a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html">OSPF::DesignatedRouterID</a>    dRouterID;
00076 
00077                     <span class="keywordflow">if</span> ((interfaceType == OSPF::Interface::Virtual) &amp;&amp;
00078                         (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a5">GetState</a> () == <a class="code" href="class_o_s_p_f_1_1_neighbor.html#w28w17">OSPF::Neighbor::DownState</a>))
00079                     {
00080                         neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a31">SetPriority</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a15">getRouterPriority</a> ());
00081                         neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a39">SetRouterDeadInterval</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a17">getRouterDeadInterval</a> ());
00082                     }
00083 
00084                     <span class="comment">/* If a change in the neighbor's Router Priority field</span>
00085 <span class="comment">                       was noted, the receiving interface's state machine is</span>
00086 <span class="comment">                       scheduled with the event NeighborChange.</span>
00087 <span class="comment">                     */</span>
00088                     <span class="keywordflow">if</span> (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a32">GetPriority</a> () != newPriority) {
00089                         neighborChanged = <span class="keyword">true</span>;
00090                     }
00091 
00092                     <span class="comment">/* If the neighbor is both declaring itself to be Designated</span>
00093 <span class="comment">                       Router (Hello Packet's Designated Router field = Neighbor IP</span>
00094 <span class="comment">                       address) and the Backup Designated Router field in the</span>
00095 <span class="comment">                       packet is equal to 0.0.0.0 and the receiving interface is in</span>
00096 <span class="comment">                       state Waiting, the receiving interface's state machine is</span>
00097 <span class="comment">                       scheduled with the event BackupSeen.</span>
00098 <span class="comment">                     */</span>
00099                     <span class="keywordflow">if</span> ((newDesignatedRouter == source) &amp;&amp;
00100                         (newBackupRouter == 0) &amp;&amp;
00101                         (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a9">GetState</a> () == <a class="code" href="class_o_s_p_f_1_1_interface.html#w24w17">OSPF::Interface::WaitingState</a>))
00102                     {
00103                         backupSeen = <span class="keyword">true</span>;
00104                     } <span class="keywordflow">else</span> {
00105                         <span class="comment">/* Otherwise, if the neighbor is declaring itself to be Designated Router and it</span>
00106 <span class="comment">                           had not previously, or the neighbor is not declaring itself</span>
00107 <span class="comment">                           Designated Router where it had previously, the receiving</span>
00108 <span class="comment">                           interface's state machine is scheduled with the event</span>
00109 <span class="comment">                           NeighborChange.</span>
00110 <span class="comment">                         */</span>
00111                         <span class="keywordflow">if</span> (((newDesignatedRouter == source) &amp;&amp;
00112                              (newDesignatedRouter != ULongFromIPv4Address (designatedAddress))) ||
00113                             ((newDesignatedRouter != source) &amp;&amp;
00114                              (source == ULongFromIPv4Address (designatedAddress))))
00115                         {
00116                             neighborChanged = <span class="keyword">true</span>;
00117                             neighborsDRStateChanged = <span class="keyword">true</span>;
00118                         }
00119                     }
00120 
00121                     <span class="comment">/* If the neighbor is declaring itself to be Backup Designated</span>
00122 <span class="comment">                       Router (Hello Packet's Backup Designated Router field =</span>
00123 <span class="comment">                       Neighbor IP address) and the receiving interface is in state</span>
00124 <span class="comment">                       Waiting, the receiving interface's state machine is</span>
00125 <span class="comment">                       scheduled with the event BackupSeen.</span>
00126 <span class="comment">                     */</span>
00127                     <span class="keywordflow">if</span> ((newBackupRouter == source) &amp;&amp;
00128                         (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a9">GetState</a> () == <a class="code" href="class_o_s_p_f_1_1_interface.html#w24w17">OSPF::Interface::WaitingState</a>))
00129                     {
00130                         backupSeen = <span class="keyword">true</span>;
00131                     } <span class="keywordflow">else</span> {
00132                         <span class="comment">/* Otherwise, if the neighbor is declaring itself to be Backup Designated Router</span>
00133 <span class="comment">                           and it had not previously, or the neighbor is not declaring</span>
00134 <span class="comment">                           itself Backup Designated Router where it had previously, the</span>
00135 <span class="comment">                           receiving interface's state machine is scheduled with the</span>
00136 <span class="comment">                           event NeighborChange.</span>
00137 <span class="comment">                         */</span>
00138                         <span class="keywordflow">if</span> (((newBackupRouter == source) &amp;&amp;
00139                              (newBackupRouter != ULongFromIPv4Address (backupAddress))) ||
00140                             ((newBackupRouter != source) &amp;&amp;
00141                              (source == ULongFromIPv4Address (backupAddress))))
00142                         {
00143                             neighborChanged = <span class="keyword">true</span>;
00144                         }
00145                     }
00146 
00147                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a29">SetNeighborID</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_packet.html#a13">getRouterID</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ());
00148                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a31">SetPriority</a> (newPriority);
00149                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a33">SetAddress</a> (srcAddress);
00150                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = newDesignatedRouter;
00151                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a54">IPv4AddressFromULong</a> (newDesignatedRouter);
00152                     <span class="keywordflow">if</span> (newDesignatedRouter != ULongFromIPv4Address (designatedAddress)) {
00153                         designatedAddress = dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a>;
00154                         drChanged = <span class="keyword">true</span>;
00155                     }
00156                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a35">SetDesignatedRouter</a> (dRouterID);
00157                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = newBackupRouter;
00158                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a54">IPv4AddressFromULong</a> (newBackupRouter);
00159                     <span class="keywordflow">if</span> (newBackupRouter != ULongFromIPv4Address (backupAddress)) {
00160                         backupAddress = dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a>;
00161                         drChanged = <span class="keyword">true</span>;
00162                     }
00163                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a37">SetBackupDesignatedRouter</a> (dRouterID);
00164                     <span class="keywordflow">if</span> (drChanged) {
00165                         neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a60">SetUpDesignatedRouters</a> (<span class="keyword">false</span>);
00166                     }
00167 
00168                     <span class="comment">/* If the neighbor router's Designated or Backup Designated Router</span>
00169 <span class="comment">                       has changed it's necessary to look up the Router IDs belonging to the</span>
00170 <span class="comment">                       new addresses.</span>
00171 <span class="comment">                     */</span>
00172                     <span class="keywordflow">if</span> (!neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a59">DesignatedRoutersAreSetUp</a> ()) {
00173                         <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* designated = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7">GetNeighborByAddress</a> (designatedAddress);
00174                         <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* backup     = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7">GetNeighborByAddress</a> (backupAddress);
00175 
00176                         <span class="keywordflow">if</span> (designated != NULL) {
00177                             dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a30">GetNeighborID</a> ();
00178                             dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a> = designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a34">GetAddress</a> ();
00179                             neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a35">SetDesignatedRouter</a> (dRouterID);
00180                         }
00181                         <span class="keywordflow">if</span> (backup != NULL) {
00182                             dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a30">GetNeighborID</a> ();
00183                             dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a> = backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a34">GetAddress</a> ();
00184                             neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a37">SetBackupDesignatedRouter</a> (dRouterID);
00185                         }
00186                         <span class="keywordflow">if</span> ((designated != NULL) &amp;&amp; (backup != NULL)) {
00187                             neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a60">SetUpDesignatedRouters</a> (<span class="keyword">true</span>);
00188                         }
00189                     }
00190                 } <span class="keywordflow">else</span> {
00191                     <a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html">OSPF::DesignatedRouterID</a>    dRouterID;
00192                     <span class="keywordtype">bool</span>                        designatedSetUp = <span class="keyword">false</span>;
00193                     <span class="keywordtype">bool</span>                        backupSetUp     = <span class="keyword">false</span>;
00194 
00195                     neighbor = <span class="keyword">new</span> <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_packet.html#a13">getRouterID</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ());
00196                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a31">SetPriority</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a15">getRouterPriority</a> ());
00197                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a33">SetAddress</a> (srcAddress);
00198                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a39">SetRouterDeadInterval</a> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a17">getRouterDeadInterval</a> ());
00199 
00200                     <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#p0">router</a>-&gt;GetMessageHandler ()-&gt;PrintEvent (<span class="stringliteral">"Hello packet received"</span>, intf, neighbor);
00201 
00202                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a19">getDesignatedRouter</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ();
00203                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a54">IPv4AddressFromULong</a> (dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a>);
00204 
00205                     <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* designated = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7">GetNeighborByAddress</a> (dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a>);
00206 
00207                     <span class="comment">// Get the Designated Router ID from the corresponding Neighbor Object.</span>
00208                     <span class="keywordflow">if</span> (designated != NULL) {
00209                         <span class="keywordflow">if</span> (designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a30">GetNeighborID</a> () != dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a>) {
00210                             dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a30">GetNeighborID</a> ();
00211                         }
00212                         designatedSetUp = <span class="keyword">true</span>;
00213                     }
00214                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a35">SetDesignatedRouter</a> (dRouterID);
00215 
00216                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a22">getBackupDesignatedRouter</a> ().<a class="code" href="class_i_p_address.html#a5">getInt</a> ();
00217                     dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a54">IPv4AddressFromULong</a> (dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a>);
00218 
00219                     <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* backup = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7">GetNeighborByAddress</a> (dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o1">ipInterfaceAddress</a>);
00220 
00221                     <span class="comment">// Get the Backup Designated Router ID from the corresponding Neighbor Object.</span>
00222                     <span class="keywordflow">if</span> (backup != NULL) {
00223                         <span class="keywordflow">if</span> (backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a30">GetNeighborID</a> () != dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a>) {
00224                             dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#o0">routerID</a> = backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a30">GetNeighborID</a> ();
00225                         }
00226                         backupSetUp = <span class="keyword">true</span>;
00227                     }
00228                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a37">SetBackupDesignatedRouter</a> (dRouterID);
00229                     <span class="keywordflow">if</span> (designatedSetUp &amp;&amp; backupSetUp) {
00230                         neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a60">SetUpDesignatedRouters</a> (<span class="keyword">true</span>);
00231                     }
00232                     intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a8">AddNeighbor</a> (neighbor);
00233                 }
00234 
00235                 neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a2">ProcessEvent</a> (OSPF::Neighbor::HelloReceived);
00236                 <span class="keywordflow">if</span> ((interfaceType == OSPF::Interface::NBMA) &amp;&amp;
00237                     (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a37">GetRouterPriority</a> () == 0) &amp;&amp;
00238                     (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a5">GetState</a> () &gt;= <a class="code" href="class_o_s_p_f_1_1_neighbor.html#w28w19">OSPF::Neighbor::InitState</a>))
00239                 {
00240                     intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a4">SendHelloPacket</a> (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a34">GetAddress</a> ());
00241                 }
00242 
00243                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   interfaceAddress       = <a class="code" href="_o_s_p_fcommon_8h.html#a55">ULongFromIPv4Address</a> (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a49">GetAddressRange</a> ().address);
00244                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    neighborsNeighborCount = helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a26">getNeighborArraySize</a> ();
00245                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
00246                 <span class="comment">/* The list of neighbors contained in the Hello Packet is</span>
00247 <span class="comment">                   examined.  If the router itself appears in this list, the</span>
00248 <span class="comment">                   neighbor state machine should be executed with the event TwoWayReceived.</span>
00249 <span class="comment">                 */</span>
00250                 <span class="keywordflow">for</span> (i = 0; i &lt; neighborsNeighborCount; i++) {
00251                     <span class="keywordflow">if</span> (helloPacket-&gt;<a class="code" href="class_o_s_p_f_hello_packet.html#a27">getNeighbor</a> (i).<a class="code" href="class_i_p_address.html#a5">getInt</a> () == interfaceAddress) {
00252                         neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a2">ProcessEvent</a> (OSPF::Neighbor::TwoWayReceived);
00253                         <span class="keywordflow">break</span>;
00254                     }
00255                 }
00256                 <span class="comment">/* Otherwise, the neighbor state machine should</span>
00257 <span class="comment">                   be executed with the event OneWayReceived, and the processing</span>
00258 <span class="comment">                   of the packet stops.</span>
00259 <span class="comment">                 */</span>
00260                 <span class="keywordflow">if</span> (i == neighborsNeighborCount) {
00261                     neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a2">ProcessEvent</a> (OSPF::Neighbor::OneWayReceived);
00262                 }
00263 
00264                 <span class="keywordflow">if</span> (neighborChanged) {
00265                     intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a2">ProcessEvent</a> (OSPF::Interface::NeighborChange);
00266                     <span class="comment">/* In some cases neighbors get stuck in TwoWay state after a DR</span>
00267 <span class="comment">                       or Backup change. (CalculateDesignatedRouter runs before the</span>
00268 <span class="comment">                       neighbors' signal of DR change + this router does not become</span>
00269 <span class="comment">                       neither DR nor backup -&gt; IsAdjacencyOK does not get called.)</span>
00270 <span class="comment">                       So to make it work (workaround) we'll call IsAdjacencyOK for</span>
00271 <span class="comment">                       all neighbors in TwoWay state from here. This shouldn't break</span>
00272 <span class="comment">                       anything because if the neighbor state doesn't have to change</span>
00273 <span class="comment">                       then NeedAdjacency returns false and nothing happnes in</span>
00274 <span class="comment">                       IsAdjacencyOK.</span>
00275 <span class="comment">                     */</span>
00276                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> neighborCount = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a55">GetNeighborCount</a> ();
00277                     <span class="keywordflow">for</span> (i = 0; i &lt; neighborCount; i++) {
00278                         <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* stuckNeighbor = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a56">GetNeighbor</a> (i);
00279                         <span class="keywordflow">if</span> (stuckNeighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a5">GetState</a> () == <a class="code" href="class_o_s_p_f_1_1_neighbor.html#w28w20">OSPF::Neighbor::TwoWayState</a>) {
00280                             stuckNeighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a2">ProcessEvent</a> (OSPF::Neighbor::IsAdjacencyOK);
00281                         }
00282                     }
00283 
00284                     <span class="keywordflow">if</span> (neighborsDRStateChanged) {
00285                         <a class="code" href="class_o_s_p_f_1_1_router_l_s_a.html">OSPF::RouterLSA</a>* routerLSA = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a59">GetArea</a> ()-&gt;FindRouterLSA (<a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#p0">router</a>-&gt;GetRouterID ());
00286 
00287                         <span class="keywordflow">if</span> (routerLSA != NULL) {
00288                             <span class="keywordtype">long</span> sequenceNumber = routerLSA-&gt;<a class="code" href="class_o_s_p_f_l_s_a.html#a6">getHeader</a> ().<a class="code" href="class_o_s_p_f_l_s_a_header.html#a18">getLsSequenceNumber</a> ();
00289                             <span class="keywordflow">if</span> (sequenceNumber == MAX_SEQUENCE_NUMBER) {
00290                                 routerLSA-&gt;<a class="code" href="class_o_s_p_f_l_s_a.html#a6">getHeader</a> ().<a class="code" href="class_o_s_p_f_l_s_a_header.html#a7">setLsAge</a> (MAX_AGE);
00291                                 intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a59">GetArea</a> ()-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a13">FloodLSA</a> (routerLSA);
00292                                 routerLSA-&gt;<a class="code" href="class_o_s_p_f_1_1_l_s_a_tracking_info.html#a4">IncrementInstallTime</a> ();
00293                             } <span class="keywordflow">else</span> {
00294                                 <a class="code" href="class_o_s_p_f_1_1_router_l_s_a.html">OSPF::RouterLSA</a>* newLSA = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a59">GetArea</a> ()-&gt;OriginateRouterLSA ();
00295 
00296                                 newLSA-&gt;<a class="code" href="class_o_s_p_f_l_s_a.html#a6">getHeader</a> ().<a class="code" href="class_o_s_p_f_l_s_a_header.html#a19">setLsSequenceNumber</a> (sequenceNumber + 1);
00297                                 newLSA-&gt;<a class="code" href="class_o_s_p_f_l_s_a.html#a6">getHeader</a> ().<a class="code" href="class_o_s_p_f_l_s_a_header.html#a21">setLsChecksum</a> (0);    <span class="comment">// TODO: calculate correct LS checksum</span>
00298                                 rebuildRoutingTable |= routerLSA-&gt;<a class="code" href="class_o_s_p_f_1_1_router_l_s_a.html#a5">Update</a> (newLSA);
00299                                 <span class="keyword">delete</span> newLSA;
00300 
00301                                 intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a59">GetArea</a> ()-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a13">FloodLSA</a> (routerLSA);
00302                             }
00303                         }
00304                     }
00305                 }
00306 
00307                 <span class="keywordflow">if</span> (backupSeen) {
00308                     intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a2">ProcessEvent</a> (OSPF::Interface::BackupSeen);
00309                 }
00310             }
00311         }
00312     }
00313 
00314     <span class="keywordflow">if</span> (rebuildRoutingTable) {
00315         <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#p0">router</a>-&gt;RebuildRoutingTable ();
00316     }
00317 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_hello_handler_8h.html">HelloHandler.h</a><li><a class="el" href="_hello_handler_8cc.html">HelloHandler.cc</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 18:22:32 2006 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.0 </small></address>
</body>
</html>
