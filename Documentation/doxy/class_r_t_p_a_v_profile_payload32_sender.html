<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>INET Framework for OMNeT++/OMNEST: RTPAVProfilePayload32Sender Class Reference</title>
<link href="opp.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.0 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>RTPAVProfilePayload32Sender Class Reference</h1><code>#include &lt;RTPAVProfilePayload32Sender.h&gt;</code>
<p>
<p>Inheritance diagram for RTPAVProfilePayload32Sender:
<p><center><img src="class_r_t_p_a_v_profile_payload32_sender.png" usemap="#RTPAVProfilePayload32Sender_map" border="0" alt=""></center>
<map name="RTPAVProfilePayload32Sender_map">
<area href="class_r_t_p_payload_sender.html" alt="RTPPayloadSender" shape="rect" coords="0,0,191,24">
</map>
<a href="class_r_t_p_a_v_profile_payload32_sender-members.html">List of all members.</a><hr><a name="_details"></a><h2>Detailed Description</h2>
An RTPAVProfilePayload32Sender is a module for sending data of payload type 32 in the rtp audio/video profile, which is mpeg video. This implementation doesn't send real mpeg data it just reads the gdf file created by Mpeg_Stat and sends rtp data packets which contain an <a class="el" href="class_r_t_p_mpeg_packet.html">RTPMpegPacket</a>. The corresponding receiver module <a class="el" href="class_r_t_p_a_v_profile_payload32_receiver.html">RTPAVProfilePayload32Receiver</a>. 
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#b0">initialize</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#b1">initializeSenderModule</a> (<a class="el" href="class_r_t_p_inner_packet.html">RTPInnerPacket</a> *rinpIn)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#b2">sendPacket</a> ()</td></tr>

<tr><td colspan="2"><br><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#p0">_initialDelay</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#p1">_framesPerSecond</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#p2">_frameNumber</a></td></tr>

</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="b0" doxytag="RTPAVProfilePayload32Sender::initialize"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void RTPAVProfilePayload32Sender::initialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initializes the module. It sets the values for clock rate and payload type. 
<p>
Reimplemented from <a class="el" href="class_r_t_p_payload_sender.html#a2">RTPPayloadSender</a>.<div class="fragment"><pre class="fragment">00037                                              {
00038 
00039     <a class="code" href="class_r_t_p_payload_sender.html#a2">RTPPayloadSender::initialize</a>();
00040 
00041     <a class="code" href="class_r_t_p_payload_sender.html#p4">_clockRate</a> = 90000;
00042     <a class="code" href="class_r_t_p_payload_sender.html#p3">_payloadType</a> = 32;
00043 };
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b1" doxytag="RTPAVProfilePayload32Sender::initializeSenderModule"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void RTPAVProfilePayload32Sender::initializeSenderModule           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_r_t_p_inner_packet.html">RTPInnerPacket</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>rinpIn</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This method reads the gdf file header. 
<p>
Reimplemented from <a class="el" href="class_r_t_p_payload_sender.html#b0">RTPPayloadSender</a>.<div class="fragment"><pre class="fragment">00121                                                                                {
00122 
00123     <span class="keywordtype">char</span> line[100];
00124     <span class="keywordtype">char</span> unit[100];
00125     <span class="keywordtype">char</span> description[100];
00126 
00127     <a class="code" href="class_r_t_p_payload_sender.html#b0">RTPPayloadSender::initializeSenderModule</a>(rinpIn);
00128 
00129     <span class="comment">// first line: fps unit description</span>
00130     <a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a>.get(line, 100, <span class="charliteral">'\n'</span>);
00131 
00132     <span class="keywordtype">float</span> fps;
00133     sscanf(line, <span class="stringliteral">"%f %s %s"</span>, &amp;fps, unit, description);
00134     <a class="code" href="class_r_t_p_a_v_profile_payload32_sender.html#p1">_framesPerSecond</a> = fps;
00135 
00136     <a class="code" href="class_r_t_p_a_v_profile_payload32_sender.html#p2">_frameNumber</a> = 0;
00137 
00138     <span class="comment">// get new line character</span>
00139     <span class="keywordtype">char</span> c;
00140     <a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a>.get(c);
00141 
00142     <span class="comment">// second line: initial delay unit description</span>
00143     <a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a>.get(line, 100, <span class="charliteral">'\n'</span>);
00144 
00145     <span class="keywordtype">float</span> delay;
00146     sscanf(line, <span class="stringliteral">"%f %s %s"</span>, &amp;delay, unit, description);
00147 
00148     <a class="code" href="class_r_t_p_a_v_profile_payload32_sender.html#p0">_initialDelay</a> = delay;
00149 
00150     <span class="comment">// wait initial delay</span>
00151 <span class="comment">//    cMessage *reminderMessage = new cMessage("next frame");</span>
00152 <span class="comment">//    scheduleAt(simTime() + _initialDelay, reminderMessage);</span>
00153 
00154 };
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b2" doxytag="RTPAVProfilePayload32Sender::sendPacket"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool RTPAVProfilePayload32Sender::sendPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This method sends one mpeg frame. It sends one or more rtp data packet. Returns false if there were no more frames. 
<p>
Reimplemented from <a class="el" href="class_r_t_p_payload_sender.html#b11">RTPPayloadSender</a>.<div class="fragment"><pre class="fragment">00157                                              {
00158 
00159     <span class="comment">// read next frame line</span>
00160     <span class="keywordtype">int</span> bits;
00161     <span class="keywordtype">char</span> unit[100];
00162     <span class="keywordtype">char</span> description[100];
00163 
00164     <a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a> &gt;&gt; bits;
00165     <a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a> &gt;&gt; unit;
00166     <a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a>.get(description, 100, <span class="charliteral">'\n'</span>);
00167 
00168     <span class="keywordtype">int</span> pictureType = 0;
00169 
00170     <span class="keywordflow">if</span> (strchr(description, <span class="charliteral">'I'</span>)) {
00171         pictureType = 1;
00172     }
00173     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(description, <span class="charliteral">'P'</span>)) {
00174         pictureType = 2;
00175     }
00176     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(description, <span class="charliteral">'B'</span>)) {
00177         pictureType = 3;
00178     }
00179     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(description, <span class="charliteral">'D'</span>)) {
00180         pictureType = 4;
00181     };
00182 
00183     <span class="keywordtype">int</span> bytesRemaining = bits / 8;
00184 
00185     <span class="keywordflow">if</span> (!<a class="code" href="class_r_t_p_payload_sender.html#p0">_inputFileStream</a>.eof()) {
00186         <span class="keywordflow">while</span> (bytesRemaining &gt; 0) {
00187             <a class="code" href="class_r_t_p_packet.html">RTPPacket</a> *rtpPacket = <span class="keyword">new</span> <a class="code" href="class_r_t_p_packet.html">RTPPacket</a>(<span class="stringliteral">"RTPPacket"</span>);
00188             <a class="code" href="class_r_t_p_mpeg_packet.html">RTPMpegPacket</a> *mpegPacket = <span class="keyword">new</span> <a class="code" href="class_r_t_p_mpeg_packet.html">RTPMpegPacket</a>(<span class="stringliteral">"MpegPacket"</span>);
00189 
00190             <span class="comment">// the only mpeg information we know is the picture type</span>
00191             mpegPacket-&gt;<a class="code" href="class_r_t_p_mpeg_packet.html#a8">setPictureType</a>(pictureType);
00192 
00193             <span class="comment">// the maximum number of real data bytes</span>
00194             <span class="keywordtype">int</span> maxDataSize = <a class="code" href="class_r_t_p_payload_sender.html#p1">_mtu</a> - rtpPacket-&gt;length() - mpegPacket-&gt;length();
00195 
00196             <span class="keywordflow">if</span> (bytesRemaining &gt; maxDataSize) {
00197 
00198                 <span class="comment">// we do not know where slices in the</span>
00199                 <span class="comment">// mpeg picture begin</span>
00200                 <span class="comment">// so we simulate by assuming a slice</span>
00201                 <span class="comment">// has a length of 64 bytes</span>
00202                 <span class="keywordtype">int</span> slicedDataSize = (maxDataSize / 64) * 64;
00203 
00204                 mpegPacket-&gt;addLength(slicedDataSize);
00205 
00206 
00207                 rtpPacket-&gt;encapsulate(mpegPacket);
00208 
00209                 bytesRemaining = bytesRemaining - slicedDataSize;
00210             }
00211             <span class="keywordflow">else</span> {
00212                 mpegPacket-&gt;addLength(bytesRemaining);
00213                 rtpPacket-&gt;encapsulate(mpegPacket);
00214                 <span class="comment">// set marker because this is</span>
00215                 <span class="comment">// the last packet of the frame</span>
00216                 rtpPacket-&gt;<a class="code" href="class_r_t_p_packet.html#a9">setMarker</a>(1);
00217                 bytesRemaining = 0;
00218             }
00219 
00220             rtpPacket-&gt;<a class="code" href="class_r_t_p_packet.html#a11">setPayloadType</a>(_payloadType);
00221             rtpPacket-&gt;<a class="code" href="class_r_t_p_packet.html#a13">setSequenceNumber</a>(_sequenceNumber);
00222             <a class="code" href="class_r_t_p_payload_sender.html#p8">_sequenceNumber</a>++;
00223 
00224 
00225             rtpPacket-&gt;<a class="code" href="class_r_t_p_packet.html#a15">setTimeStamp</a>(_timeStampBase + (_initialDelay + (1 / _framesPerSecond) * (<span class="keywordtype">double</span>)_frameNumber) * _clockRate);
00226             rtpPacket-&gt;<a class="code" href="class_r_t_p_packet.html#a17">setSSRC</a>(_ssrc);
00227 
00228 
00229             <a class="code" href="class_r_t_p_inner_packet.html">RTPInnerPacket</a> *rinpOut = <span class="keyword">new</span> <a class="code" href="class_r_t_p_inner_packet.html">RTPInnerPacket</a>(<span class="stringliteral">"dataOut()"</span>);
00230 
00231 
00232             rinpOut-&gt;<a class="code" href="class_r_t_p_inner_packet.html#a22">dataOut</a>(rtpPacket);
00233 
00234             send(rinpOut, <span class="stringliteral">"toProfile"</span>);
00235 
00236         };
00237         <a class="code" href="class_r_t_p_a_v_profile_payload32_sender.html#p2">_frameNumber</a>++;
00238 
00239         <a class="code" href="class_r_t_p_payload_sender.html#p10">_reminderMessage</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">"nextFrame"</span>);
00240         scheduleAt(simTime() + 1.0 / _framesPerSecond, _reminderMessage);
00241         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00242     }
00243     <span class="keywordflow">else</span> {
00244         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00245     }
00246 }</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Data Documentation</h2>
<a class="anchor" name="p2" doxytag="RTPAVProfilePayload32Sender::_frameNumber"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">double <a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#p2">RTPAVProfilePayload32Sender::_frameNumber</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The number of the current mpeg frame. Needed for calculating the rtp time stamp in the rtp data packets.     </td>
  </tr>
</table>
<a class="anchor" name="p1" doxytag="RTPAVProfilePayload32Sender::_framesPerSecond"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">double <a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#p1">RTPAVProfilePayload32Sender::_framesPerSecond</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The number of frames per second of the mpeg video.     </td>
  </tr>
</table>
<a class="anchor" name="p0" doxytag="RTPAVProfilePayload32Sender::_initialDelay"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">double <a class="el" href="class_r_t_p_a_v_profile_payload32_sender.html#p0">RTPAVProfilePayload32Sender::_initialDelay</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
The initial delay of the mpeg video.     </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_r_t_p_a_v_profile_payload32_sender_8h.html">RTPAVProfilePayload32Sender.h</a><li><a class="el" href="_r_t_p_a_v_profile_payload32_sender_8cc.html">RTPAVProfilePayload32Sender.cc</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 18:22:29 2006 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.0 </small></address>
</body>
</html>
