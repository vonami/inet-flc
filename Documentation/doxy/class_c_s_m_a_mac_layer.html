<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>INET Framework for OMNeT++/OMNEST: CSMAMacLayer Class Reference</title>
<link href="opp.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.0 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>CSMAMacLayer Class Reference</h1><code>#include &lt;CSMAMacLayer.h&gt;</code>
<p>
<p>Inheritance diagram for CSMAMacLayer:
<p><center><img src="class_c_s_m_a_mac_layer.png" usemap="#CSMAMacLayer_map" border="0" alt=""></center>
<map name="CSMAMacLayer_map">
<area href="class_wireless_mac_base.html" alt="WirelessMacBase" shape="rect" coords="0,0,113,24">
<area href="class_i_notifiable.html" alt="INotifiable" shape="rect" coords="123,0,236,24">
</map>
<a href="class_c_s_m_a_mac_layer-members.html">List of all members.</a><hr><a name="_details"></a><h2>Detailed Description</h2>
MAC module which provides non-persistent CSMA. 
<p>
This is an implementation of a simple non-persistent CSMA. The idea of nonpersistent CSMA is "listen before talk". Before attempting to transmit, a station will sense the medium for a carrier signal, which, if present, indicates that some other station is sending.<p>
If the channel is busy a random waiting time is computed and after this time the channel is sensed again. Once the channel gets idle the message is sent. (State of the channel is obtained from <a class="el" href="class_snr_eval.html">SnrEval</a> via <a class="el" href="class_notification_board.html">NotificationBoard</a>.)<p>
An option of this module is to use a queue. If a packet from the upper layer arrives although there is still another packet waiting for its transmission or being transmitted the new packet can be stored in this queue. The length of this queue can be specified by the user in the omnetpp.ini file. By default the length is 0. If the queue is full or there is no queue (length = 0) new packet(s) will be deleted.<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>Inform upper layers about the full queue! </dd></dl>
ATTENTION: Imagine the following scenario:<p>
Several stations receive a broadcast request packet, usally exactly at the same time. They will all try to answer at exactly the same time, i.e. they all will sense the channel at exactly the same time and start to transmit because the channel was sensed idle by all of them. Therefore a small random delay should be built into one/some of the upper layers to simulate a random processing time!<p>
The TestApplLayer e.g. implements such a processing delay!<p>
<dl compact><dt><b>Author:</b></dt><dd>Marc Löbbers, Yosia Hadisusanto </dd></dl>

<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#a0">CSMAMacLayer</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#a1">~CSMAMacLayer</a> ()</td></tr>

<tr><td colspan="2"><br><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b0">initialize</a> (int)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialization of the module and some variables.  <a href="#b0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b1">registerInterface</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Register the interface in <a class="el" href="class_interface_table.html">InterfaceTable</a>.  <a href="#b1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b2">finish</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Delete all dynamically allocated objects of the module.  <a href="#b2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b3">handleLowerMsg</a> (cMessage *)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle messages from lower layer.  <a href="#b3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b4">handleUpperMsg</a> (cMessage *)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle messages from upper layer.  <a href="#b4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b5">handleSelfMsg</a> (cMessage *)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle self messages such as timers.  <a href="#b5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual <a class="el" href="class_mac_pkt.html">MacPkt</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b6">encapsMsg</a> (cMessage *netw)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Encapsulate the given higher-layer packet into <a class="el" href="class_mac_pkt.html">MacPkt</a>.  <a href="#b6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#b7">receiveChangeNotification</a> (int category, cPolymorphic *details)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Called by the <a class="el" href="class_notification_board.html">NotificationBoard</a> whenever a change occurs we're interested in.  <a href="#b7"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_m_a_c_address.html">MACAddress</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#p0">myMacAddr</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">mac address  <a href="#p0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_radio_state.html#w4">RadioState::State</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#p1">radioState</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Current state of the radio (kept updated by <a class="el" href="class_c_s_m_a_mac_layer.html#b7">receiveChangeNotification()</a>).  <a href="#p1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">cQueue&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#p2">macQueue</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">A queue to store packets from upper layer in case another packet is still waiting for transmission..  <a href="#p2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#p3">queueLength</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">length of the queue  <a href="#p3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">cMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#p4">timer</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Timer for backoff in case the channel is busy.  <a href="#p4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">simtime_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_c_s_m_a_mac_layer.html#p5">sendTime</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Used to store the last time a message was sent.  <a href="#p5"></a><br></td></tr>
</table>
<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="a0" doxytag="CSMAMacLayer::CSMAMacLayer"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">CSMAMacLayer::CSMAMacLayer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00031 {
00032     <a class="code" href="class_c_s_m_a_mac_layer.html#p4">timer</a> = NULL;
00033 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="CSMAMacLayer::~CSMAMacLayer"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">CSMAMacLayer::~<a class="el" href="class_c_s_m_a_mac_layer.html">CSMAMacLayer</a>           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00036 {
00037     cancelAndDelete(timer);
00038 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="b6" doxytag="CSMAMacLayer::encapsMsg"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_mac_pkt.html">MacPkt</a> * CSMAMacLayer::encapsMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>netw</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Encapsulate the given higher-layer packet into <a class="el" href="class_mac_pkt.html">MacPkt</a>. 
<p>
Encapsulates the received network-layer packet into a <a class="el" href="class_mac_pkt.html">MacPkt</a> and set all needed header fields. <div class="fragment"><pre class="fragment">00230 {
00231     <a class="code" href="class_mac_pkt.html">MacPkt</a> *pkt = <span class="keyword">new</span> <a class="code" href="class_mac_pkt.html">MacPkt</a>(netw-&gt;name());
00232     pkt-&gt;setLength(272);
00233 
00234     <span class="comment">// copy dest address from the Control Info attached to the network</span>
00235     <span class="comment">// mesage by the network layer</span>
00236     <a class="code" href="class_ieee802_ctrl.html">Ieee802Ctrl</a> *ctrl = check_and_cast&lt;Ieee802Ctrl *&gt;(netw-&gt;removeControlInfo());
00237 
00238     <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"ctrl removed, mac addr="</span> &lt;&lt; ctrl-&gt;<a class="code" href="class_ieee802_ctrl.html#a9">getDest</a>() &lt;&lt; endl;
00239     pkt-&gt;<a class="code" href="class_mac_pkt.html#a9">setDestAddr</a>(ctrl-&gt;<a class="code" href="class_ieee802_ctrl.html#a9">getDest</a>());
00240 
00241     <span class="comment">//delete the control info</span>
00242     <span class="keyword">delete</span> ctrl;
00243 
00244     <span class="comment">//set the src address to own mac address</span>
00245     pkt-&gt;<a class="code" href="class_mac_pkt.html#a12">setSrcAddr</a>(myMacAddr);
00246 
00247     <span class="comment">//encapsulate the network packet</span>
00248     pkt-&gt;encapsulate(netw);
00249     <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"pkt encapsulated\n"</span>;
00250 
00251     <span class="keywordflow">return</span> pkt;
00252 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b2" doxytag="CSMAMacLayer::finish"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::finish           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Delete all dynamically allocated objects of the module. 
<p>
<div class="fragment"><pre class="fragment">00110 {
00111 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b3" doxytag="CSMAMacLayer::handleLowerMsg"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::handleLowerMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Handle messages from lower layer. 
<p>
Compare the address of this Host with the destination address in frame. If they are equal or the frame is broadcast, we send this frame to the upper layer. If not delete it. 
<p>
Implements <a class="el" href="class_wireless_mac_base.html#z121_2">WirelessMacBase</a>.<div class="fragment"><pre class="fragment">00209 {
00210     <a class="code" href="class_mac_pkt.html">MacPkt</a> *mac = check_and_cast&lt;MacPkt *&gt;(msg);
00211 
00212     <span class="comment">//only foward to upper layer if message is for me or broadcast</span>
00213     <span class="keywordflow">if</span> (mac-&gt;<a class="code" href="class_mac_pkt.html#a7">getDestAddr</a>() == <a class="code" href="class_c_s_m_a_mac_layer.html#p0">myMacAddr</a> || mac-&gt;<a class="code" href="class_mac_pkt.html#a7">getDestAddr</a>().<a class="code" href="class_m_a_c_address.html#a11">isBroadcast</a>())
00214     {
00215         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"sending pkt to upper...\n"</span>;
00216         <a class="code" href="class_wireless_mac_base.html#z123_1">sendUp</a>(mac);
00217     }
00218     <span class="keywordflow">else</span>
00219     {
00220         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"packet not for me, deleting...\n"</span>;
00221         <span class="keyword">delete</span> mac;
00222     }
00223 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b5" doxytag="CSMAMacLayer::handleSelfMsg"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::handleSelfMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Handle self messages such as timers. 
<p>
After the timer expires try to retransmit the message by calling handleUpperMsg again. 
<p>
Implements <a class="el" href="class_wireless_mac_base.html#z121_0">WirelessMacBase</a>.<div class="fragment"><pre class="fragment">00195 {
00196     <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"timer expired, calling handleUpperMsg again.. time: "</span> &lt;&lt; simTime() &lt;&lt; endl;
00197 
00198     <span class="comment">// timer expired for a buffered frame, try to send again</span>
00199     <a class="code" href="class_c_s_m_a_mac_layer.html#b4">handleUpperMsg</a>((<a class="code" href="class_mac_pkt.html">MacPkt</a> *) msg-&gt;contextPointer());
00200 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b4" doxytag="CSMAMacLayer::handleUpperMsg"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::handleUpperMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Handle messages from upper layer. 
<p>
First it has to be checked whether a frame is currently being transmitted or waiting to be transmitted. If so the newly arrived message is stored in a queue. If there is no queue or it is full print a warning.<p>
Before transmitting a frame it is tested whether the channel is busy at the moment or not. If the channel is busy, a short random time will be generated and the <a class="el" href="class_mac_pkt.html">MacPkt</a> is buffered for this time, before a next attempt to send the packet is started.<p>
If channel is idle the frame will be transmitted immediately. 
<p>
Implements <a class="el" href="class_wireless_mac_base.html#z121_1">WirelessMacBase</a>.<div class="fragment"><pre class="fragment">00128 {
00129     <a class="code" href="class_mac_pkt.html">MacPkt</a> *mac = <a class="code" href="class_c_s_m_a_mac_layer.html#b6">encapsMsg</a>(msg);
00130 
00131     <span class="comment">// message has to be queued if another message is waiting to be send</span>
00132     <span class="comment">// or if we are already trying to send another message</span>
00133 
00134     <span class="comment">// the comparison with sendTime is necessary so that concurrently</span>
00135     <span class="comment">// arriving messages are handled sequentially. As soon as one</span>
00136     <span class="comment">// message arrived at simTime() is passed to lower layers all other</span>
00137     <span class="comment">// messages arriving at the same time will be buffered.</span>
00138     <span class="keywordflow">if</span> (<a class="code" href="class_c_s_m_a_mac_layer.html#p4">timer</a>-&gt;isScheduled() || <a class="code" href="class_c_s_m_a_mac_layer.html#p1">radioState</a> == <a class="code" href="class_radio_state.html#w4w2">RadioState::TRANSMIT</a> || <a class="code" href="class_c_s_m_a_mac_layer.html#p5">sendTime</a> == simTime())
00139     {
00140 
00141         <span class="comment">// if there is no queue the message will be deleted</span>
00142         <span class="keywordflow">if</span> (queueLength == 0)
00143         {
00144             <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"New packet arrived though another is still waiting for being sent, "</span>
00145                 <span class="stringliteral">" and buffer size is zero. New packet is deleted.\n"</span>;
00146             <span class="comment">// TODO: Signal this to upper layer!</span>
00147             <span class="keyword">delete</span> mac;
00148             <span class="keywordflow">return</span>;
00149         }
00150 
00151         <span class="comment">// the queue is not full yet so we can queue the message</span>
00152         <span class="keywordflow">if</span> (<a class="code" href="class_c_s_m_a_mac_layer.html#p2">macQueue</a>.length() &lt; <a class="code" href="class_c_s_m_a_mac_layer.html#p3">queueLength</a>)
00153         {
00154             <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"already transmitting, putting pkt into queue...\n"</span>;
00155             <a class="code" href="class_c_s_m_a_mac_layer.html#p2">macQueue</a>.insert(mac);
00156             <span class="keywordflow">return</span>;
00157         }
00158         <span class="comment">// queue is full, message has to be deleted</span>
00159         <span class="keywordflow">else</span>
00160         {
00161             <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"New packet arrived, but queue is FULL, so new packet is deleted\n"</span>;
00162             <span class="comment">// TODO: Signal this to upper layer!!</span>
00163             <span class="keyword">delete</span> mac;
00164             <span class="keywordflow">return</span>;
00165         }
00166     }
00167 
00168     <span class="comment">// no message is scheduled for sending or currently being sent</span>
00169 
00170     <span class="comment">// check the radio status and transmit the message if the channel is</span>
00171     <span class="comment">// idle. Otherwise backoff for a random time and try again</span>
00172     <span class="keywordflow">if</span> (radioState == RadioState::IDLE)
00173     {
00174         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"CHANNEL IDLE, send...\n"</span>;
00175         <a class="code" href="class_wireless_mac_base.html#z123_0">sendDown</a>(mac);
00176         <span class="comment">//store the sending time</span>
00177         <a class="code" href="class_c_s_m_a_mac_layer.html#p5">sendTime</a> = simTime();
00178     }
00179     <span class="keywordflow">else</span>
00180     {
00181         <a class="code" href="class_c_s_m_a_mac_layer.html#p4">timer</a>-&gt;setContextPointer(mac);
00182         <span class="keywordtype">double</span> randomTime = intuniform(0, 10) / 100.0;
00183         scheduleAt(simTime() + randomTime, timer);
00184         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"CHANNEL BUSY, I will try to retransmit at "</span> &lt;&lt; simTime() + randomTime &lt;&lt; <span class="stringliteral">".\n"</span>;
00185     }
00186 
00187 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b0" doxytag="CSMAMacLayer::initialize"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::initialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Initialization of the module and some variables. 
<p>

<p>
Reimplemented from <a class="el" href="class_wireless_mac_base.html#b0">WirelessMacBase</a>.<div class="fragment"><pre class="fragment">00041 {
00042     <a class="code" href="class_wireless_mac_base.html#b0">WirelessMacBase::initialize</a>(stage);
00043 
00044     <span class="keywordflow">if</span> (stage == 0)
00045     {
00046         <a class="code" href="class_c_s_m_a_mac_layer.html#p3">queueLength</a> = hasPar(<span class="stringliteral">"queueLength"</span>) ? par(<span class="stringliteral">"queueLength"</span>) : 0;
00047         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"queueLength = "</span> &lt;&lt; <a class="code" href="class_c_s_m_a_mac_layer.html#p3">queueLength</a> &lt;&lt; endl;
00048 
00049         <span class="comment">//subscribe for the information of the carrier sense</span>
00050         <a class="code" href="class_wireless_mac_base.html#p0">nb</a>-&gt;<a class="code" href="class_notification_board.html#z22_0">subscribe</a>(<span class="keyword">this</span>, NF_RADIOSTATE_CHANGED);
00051 
00052         <span class="comment">// initialize the timer</span>
00053         <a class="code" href="class_c_s_m_a_mac_layer.html#p4">timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">"backoff"</span>);
00054 
00055         <a class="code" href="class_c_s_m_a_mac_layer.html#p1">radioState</a> = <a class="code" href="class_radio_state.html#w4w0">RadioState::IDLE</a>; <span class="comment">// until 1st receiveChangeNotification()</span>
00056 
00057         <span class="comment">// get registered in InterfaceTable</span>
00058         <a class="code" href="class_c_s_m_a_mac_layer.html#b1">registerInterface</a>();
00059     }
00060 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b7" doxytag="CSMAMacLayer::receiveChangeNotification"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::receiveChangeNotification           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>category</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>cPolymorphic *&nbsp;</td>
          <td class="mdname" nowrap> <em>details</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Called by the <a class="el" href="class_notification_board.html">NotificationBoard</a> whenever a change occurs we're interested in. 
<p>
Update the internal copy of the <a class="el" href="class_radio_state.html">RadioState</a>.<p>
If the <a class="el" href="class_radio_state.html">RadioState</a> switched from TRANSMIT to IDLE and there are still messages in the queue, call handleUpperMsg in order to try to send those now. 
<p>
Implements <a class="el" href="class_i_notifiable.html#a1">INotifiable</a>.<div class="fragment"><pre class="fragment">00262 {
00263     Enter_Method(<span class="stringliteral">"receiveChangeNotification(%s, %s)"</span>, <a class="code" href="_notifier_consts_8cc.html#a0">notificationCategoryName</a>(category),
00264                  details?details-&gt;info().c_str() : <span class="stringliteral">"n/a"</span>);
00265     <a class="code" href="_notifier_consts_8cc.html#a1">printNotificationBanner</a>(category, details);
00266 
00267     <span class="keywordflow">if</span> (category == NF_RADIOSTATE_CHANGED)
00268     {
00269         <span class="comment">// update the local copy of the radio state</span>
00270         <a class="code" href="class_c_s_m_a_mac_layer.html#p1">radioState</a> = check_and_cast&lt;RadioState *&gt;(details)-&gt;getState();
00271 
00272         <span class="comment">// NOTE: we may be invoked during INIT STAGE 1 too, when SnrEval notifies us</span>
00273         <span class="comment">// about the initial radio state. This function has to work correctly</span>
00274         <span class="comment">// even when called during initialization phase!</span>
00275 
00276         <span class="comment">// if the channel is idle now, the queue is not empty and no timer</span>
00277         <span class="comment">// is scheduled, this means that sending the previous message is</span>
00278         <span class="comment">// complete and the next one can be taken out of the queue</span>
00279         <span class="keywordflow">if</span> (radioState == RadioState::IDLE &amp;&amp; !<a class="code" href="class_c_s_m_a_mac_layer.html#p2">macQueue</a>.empty() &amp;&amp; !<a class="code" href="class_c_s_m_a_mac_layer.html#p4">timer</a>-&gt;isScheduled())
00280         {
00281             <a class="code" href="class_c_s_m_a_mac_layer.html#p4">timer</a>-&gt;setContextPointer(<a class="code" href="class_c_s_m_a_mac_layer.html#p2">macQueue</a>.pop());
00282             <span class="keywordtype">double</span> randomTime = intuniform(0, 10) / 100.0;
00283             scheduleAt(simTime() + randomTime, timer);
00284             <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"taking next pkt out of queue, schedule at "</span> &lt;&lt; simTime() + randomTime &lt;&lt; endl;
00285         }
00286     }
00287 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b1" doxytag="CSMAMacLayer::registerInterface"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void CSMAMacLayer::registerInterface           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Register the interface in <a class="el" href="class_interface_table.html">InterfaceTable</a>. 
<p>
<div class="fragment"><pre class="fragment">00063 {
00064     <a class="code" href="class_interface_entry.html">InterfaceEntry</a> *e = <span class="keyword">new</span> <a class="code" href="class_interface_entry.html">InterfaceEntry</a>();
00065 
00066     <span class="comment">// interface name: NetworkInterface module's name without special characters ([])</span>
00067     <span class="keywordtype">char</span> *interfaceName = <span class="keyword">new</span> <span class="keywordtype">char</span>[strlen(parentModule()-&gt;fullName()) + 1];
00068     <span class="keywordtype">char</span> *d = interfaceName;
00069     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">char</span> *s = parentModule()-&gt;fullName(); *s; s++)
00070         if (isalnum(*s))
00071             *d++ = *s;
00072     *d = '\0';
00073 
00074     e-&gt;setName(interfaceName);
00075     delete [] interfaceName;
00076 
00077     const <span class="keywordtype">char</span> *addrstr = par("address");
00078     if (!strcmp(addrstr, "auto"))
00079     {
00080         <span class="comment">// assign automatic address</span>
00081         <a class="code" href="class_c_s_m_a_mac_layer.html#p0">myMacAddr</a> = <a class="code" href="class_m_a_c_address.html#e0">MACAddress::generateAutoAddress</a>();
00082 
00083         <span class="comment">// change module parameter from "auto" to concrete address</span>
00084         par(<span class="stringliteral">"address"</span>).setStringValue(<a class="code" href="class_c_s_m_a_mac_layer.html#p0">myMacAddr</a>.<a class="code" href="class_m_a_c_address.html#a14">str</a>().c_str());
00085     }
00086     <span class="keywordflow">else</span>
00087     {
00088         <a class="code" href="class_c_s_m_a_mac_layer.html#p0">myMacAddr</a>.<a class="code" href="class_m_a_c_address.html#a6">setAddress</a>(addrstr);
00089     }
00090     e-&gt;<a class="code" href="class_interface_entry.html#a31">setMACAddress</a>(myMacAddr);
00091 
00092     <span class="comment">// generate interface identifier for IPv6</span>
00093     e-&gt;<a class="code" href="class_interface_entry.html#a32">setInterfaceToken</a>(<a class="code" href="class_c_s_m_a_mac_layer.html#p0">myMacAddr</a>.<a class="code" href="class_m_a_c_address.html#a19">formInterfaceIdentifier</a>());
00094 
00095     <span class="comment">// MTU on 802.11 = ?</span>
00096     e-&gt;<a class="code" href="class_interface_entry.html#a24">setMtu</a>(1500);  <span class="comment">// FIXME</span>
00097 
00098     <span class="comment">// capabilities</span>
00099     e-&gt;<a class="code" href="class_interface_entry.html#a26">setBroadcast</a>(<span class="keyword">true</span>);
00100     e-&gt;<a class="code" href="class_interface_entry.html#a27">setMulticast</a>(<span class="keyword">true</span>);
00101     e-&gt;<a class="code" href="class_interface_entry.html#a28">setPointToPoint</a>(<span class="keyword">false</span>);
00102 
00103     <span class="comment">// add</span>
00104     <a class="code" href="class_interface_table.html">InterfaceTable</a> *ift = <a class="code" href="class_interface_table_access.html">InterfaceTableAccess</a>().get();
00105     ift-&gt;<a class="code" href="class_interface_table.html#a3">addInterface</a>(e, <span class="keyword">this</span>);
00106 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Data Documentation</h2>
<a class="anchor" name="p2" doxytag="CSMAMacLayer::macQueue"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">cQueue <a class="el" href="class_c_s_m_a_mac_layer.html#p2">CSMAMacLayer::macQueue</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
A queue to store packets from upper layer in case another packet is still waiting for transmission.. 
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p0" doxytag="CSMAMacLayer::myMacAddr"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_m_a_c_address.html">MACAddress</a> <a class="el" href="class_c_s_m_a_mac_layer.html#p0">CSMAMacLayer::myMacAddr</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
mac address 
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p3" doxytag="CSMAMacLayer::queueLength"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int <a class="el" href="class_c_s_m_a_mac_layer.html#p3">CSMAMacLayer::queueLength</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
length of the queue 
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p1" doxytag="CSMAMacLayer::radioState"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_radio_state.html#w4">RadioState::State</a> <a class="el" href="class_c_s_m_a_mac_layer.html#p1">CSMAMacLayer::radioState</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Current state of the radio (kept updated by <a class="el" href="class_c_s_m_a_mac_layer.html#b7">receiveChangeNotification()</a>). 
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p5" doxytag="CSMAMacLayer::sendTime"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">simtime_t <a class="el" href="class_c_s_m_a_mac_layer.html#p5">CSMAMacLayer::sendTime</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Used to store the last time a message was sent. 
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="p4" doxytag="CSMAMacLayer::timer"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">cMessage* <a class="el" href="class_c_s_m_a_mac_layer.html#p4">CSMAMacLayer::timer</a><code> [protected]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Timer for backoff in case the channel is busy. 
<p>
    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_c_s_m_a_mac_layer_8h.html">CSMAMacLayer.h</a><li><a class="el" href="_c_s_m_a_mac_layer_8cc.html">CSMAMacLayer.cc</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 18:22:21 2006 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.0 </small></address>
</body>
</html>
