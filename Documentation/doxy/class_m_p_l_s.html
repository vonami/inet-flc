<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>INET Framework for OMNeT++/OMNEST: MPLS Class Reference</title>
<link href="opp.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.0 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>MPLS Class Reference</h1><code>#include &lt;MPLS.h&gt;</code>
<p>
<a href="class_m_p_l_s-members.html">List of all members.</a><hr><a name="_details"></a><h2>Detailed Description</h2>
Implements the MPLS protocol; see the NED file for more info. 
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#b0">initialize</a> (int stage)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#b1">numInitStages</a> () const </td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#b2">handleMessage</a> (cMessage *msg)</td></tr>

<tr><td colspan="2"><br><h2>Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d0">processPacketFromL3</a> (cMessage *msg)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d1">processPacketFromL2</a> (cMessage *msg)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d2">processMPLSPacketFromL2</a> (<a class="el" href="class_m_p_l_s_packet.html">MPLSPacket</a> *mplsPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d3">tryLabelAndForwardIPDatagram</a> (<a class="el" href="class_i_p_datagram.html">IPDatagram</a> *ipdatagram)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d4">labelAndForwardIPDatagram</a> (<a class="el" href="class_i_p_datagram.html">IPDatagram</a> *ipdatagram)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d5">sendToL2</a> (cMessage *msg, int gateIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#d6">doStackOps</a> (<a class="el" href="class_m_p_l_s_packet.html">MPLSPacket</a> *mplsPacket, const <a class="el" href="_l_i_b_table_8h.html#a3">LabelOpVector</a> &amp;outLabel)</td></tr>

<tr><td colspan="2"><br><h2>Private Attributes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">simtime_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#r0">delay1</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_l_i_b_table.html">LIBTable</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#r1">lt</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_interface_table.html">InterfaceTable</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#r2">ift</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="class_i_classifier.html">IClassifier</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_m_p_l_s.html#r3">pct</a></td></tr>

</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="d6" doxytag="MPLS::doStackOps"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::doStackOps           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_m_p_l_s_packet.html">MPLSPacket</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>mplsPacket</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>const <a class="el" href="_l_i_b_table_8h.html#a3">LabelOpVector</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>outLabel</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00165 {
00166     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n = outLabel.size();
00167 
00168     <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"doStackOps: "</span> &lt;&lt; outLabel &lt;&lt; endl;
00169 
00170     ASSERT(n &gt;= 0);
00171 
00172     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt;  n; i++)
00173     {
00174         <span class="keywordflow">switch</span> (outLabel[i].optcode)
00175         {
00176             <span class="keywordflow">case</span> <a class="code" href="_l_i_b_table_8h.html#a0">PUSH_OPER</a>:
00177                 mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a5">pushLabel</a>(outLabel[i].label);
00178                 <span class="keywordflow">break</span>;
00179 
00180             <span class="keywordflow">case</span> <a class="code" href="_l_i_b_table_8h.html#a1">SWAP_OPER</a>:
00181                 ASSERT(mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a7">hasLabel</a>());
00182                 mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a4">swapLabel</a>(outLabel[i].label);
00183                 <span class="keywordflow">break</span>;
00184 
00185             <span class="keywordflow">case</span> <a class="code" href="_l_i_b_table_8h.html#a2">POP_OPER</a>:
00186                 ASSERT(mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a7">hasLabel</a>());
00187                 mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a6">popLabel</a>();
00188                 <span class="keywordflow">break</span>;
00189 
00190             <span class="keywordflow">default</span>:
00191                 error(<span class="stringliteral">"Unknown MPLS OptCode %d"</span>, outLabel[i].optcode);
00192         }
00193     }
00194 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b2" doxytag="MPLS::handleMessage"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::handleMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00064 {
00065     <span class="keywordflow">if</span> (!strcmp(msg-&gt;arrivalGate()-&gt;name(), <span class="stringliteral">"ifIn"</span>))
00066     {
00067         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"Processing message from L2: "</span> &lt;&lt; msg &lt;&lt; endl;
00068         <a class="code" href="class_m_p_l_s.html#d1">processPacketFromL2</a>(msg);
00069     }
00070     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(msg-&gt;arrivalGate()-&gt;name(), <span class="stringliteral">"netwIn"</span>))
00071     {
00072         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"Processing message from L3: "</span> &lt;&lt; msg &lt;&lt; endl;
00073         <a class="code" href="class_m_p_l_s.html#d0">processPacketFromL3</a>(msg);
00074     }
00075     <span class="keywordflow">else</span>
00076     {
00077         error(<span class="stringliteral">"unexpected message: %s"</span>, msg-&gt;name());
00078     }
00079 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b0" doxytag="MPLS::initialize"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::initialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>stage</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00037 {
00038     <span class="keywordflow">if</span> (stage!=3) <span class="comment">// interfaceTable must be initialized</span>
00039         return;
00040 
00041     lt = <a class="code" href="class_l_i_b_table_access.html">LIBTableAccess</a>().get();
00042     ift = <a class="code" href="class_interface_table_access.html">InterfaceTableAccess</a>().get();
00043 
00044     pct = check_and_cast&lt;<a class="code" href="class_i_classifier.html">IClassifier</a>*&gt;(parentModule()-&gt;submodule(par("classifier")));
00045 
00046     <span class="comment">/*</span>
00047 <span class="comment">     * we now send plain IPDatagrams instead of packets with label=-1</span>
00048 <span class="comment">     * and we thus do not need this extra configuration</span>
00049 <span class="comment">     *</span>
00050 <span class="comment">    labelIf.resize(ift-&gt;numInterfaces());</span>
00051 <span class="comment">    cStringTokenizer tokenizer(par("peers"));</span>
00052 <span class="comment">    const char *token;</span>
00053 <span class="comment">    while ((token = tokenizer.nextToken())!=NULL)</span>
00054 <span class="comment">    {</span>
00055 <span class="comment">        ASSERT(ift-&gt;interfaceByName(token));</span>
00056 <span class="comment">        int n = ift-&gt;interfaceByName(token)-&gt;outputPort();</span>
00057 <span class="comment">        ASSERT(n &gt;= 0 &amp;&amp; n &lt; labelIf.size());</span>
00058 <span class="comment">        labelIf[n] = true;</span>
00059 <span class="comment">    }</span>
00060 <span class="comment">    */</span>
00061 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d4" doxytag="MPLS::labelAndForwardIPDatagram"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::labelAndForwardIPDatagram           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_i_p_datagram.html">IPDatagram</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ipdatagram</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00150 {
00151     <span class="keywordflow">if</span> (<a class="code" href="class_m_p_l_s.html#d3">tryLabelAndForwardIPDatagram</a>(ipdatagram))
00152         return;
00153 
00154     <span class="comment">// handling our outgoing IP traffic that didn't match any FEC/LSP</span>
00155     <span class="comment">// do not use labelAndForwardIPDatagram for packets arriving to ingress!</span>
00156 
00157     EV &lt;&lt; "FEC not resolved, doing regular L3 routing" &lt;&lt; endl;
00158 
00159     <span class="keywordtype">int</span> gateIndex = ipdatagram-&gt;arrivalGate()-&gt;index();
00160 
00161     sendToL2(ipdatagram, gateIndex);
00162 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="b1" doxytag="MPLS::numInitStages"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">virtual int MPLS::numInitStages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap> const<code> [inline, protected, virtual]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00049 {<span class="keywordflow">return</span> 5;}
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d2" doxytag="MPLS::processMPLSPacketFromL2"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::processMPLSPacketFromL2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_m_p_l_s_packet.html">MPLSPacket</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>mplsPacket</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00223 {
00224     <span class="keywordtype">int</span> gateIndex = mplsPacket-&gt;arrivalGate()-&gt;index();
00225     <a class="code" href="class_interface_entry.html">InterfaceEntry</a> *ie = <a class="code" href="class_m_p_l_s.html#r2">ift</a>-&gt;<a class="code" href="class_interface_table.html#a8">interfaceByNetworkLayerGateIndex</a>(gateIndex);
00226     std::string senderInterface = ie-&gt;<a class="code" href="class_interface_entry.html#a5">name</a>();
00227     ASSERT(mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a7">hasLabel</a>());
00228     <span class="keywordtype">int</span> oldLabel = mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a8">topLabel</a>();
00229 
00230     <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"Received "</span> &lt;&lt; mplsPacket &lt;&lt; <span class="stringliteral">" from L2, label="</span> &lt;&lt; oldLabel &lt;&lt; <span class="stringliteral">" inInterface="</span> &lt;&lt; senderInterface &lt;&lt; endl;
00231 
00232     <span class="keywordflow">if</span> (oldLabel==-1)
00233     {
00234         <span class="comment">// This is a IP native packet (RSVP/TED traffic)</span>
00235         <span class="comment">// Decapsulate the message and pass up to L3</span>
00236         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">": decapsulating and sending up\n"</span>;
00237 
00238         <a class="code" href="class_i_p_datagram.html">IPDatagram</a> *ipdatagram = check_and_cast&lt;IPDatagram *&gt;(mplsPacket-&gt;decapsulate());
00239         <span class="keyword">delete</span> mplsPacket;
00240         send(ipdatagram, <span class="stringliteral">"netwOut"</span>, gateIndex);
00241         <span class="keywordflow">return</span>;
00242     }
00243 
00244     <a class="code" href="_l_i_b_table_8h.html#a3">LabelOpVector</a> outLabel;
00245     std::string outInterface;
00246     <span class="keywordtype">int</span> color;
00247 
00248     <span class="keywordtype">bool</span> found = <a class="code" href="class_m_p_l_s.html#r1">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#a0">resolveLabel</a>(senderInterface, oldLabel, outLabel, outInterface, color);
00249     <span class="keywordflow">if</span> (!found)
00250     {
00251         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"discarding packet, incoming label not resolved"</span> &lt;&lt; endl;
00252 
00253         <span class="keyword">delete</span> mplsPacket;
00254         <span class="keywordflow">return</span>;
00255     }
00256 
00257     <span class="keywordtype">int</span> outgoingPort = <a class="code" href="class_m_p_l_s.html#r2">ift</a>-&gt;<a class="code" href="class_interface_table.html#a9">interfaceByName</a>(outInterface.c_str())-&gt;<a class="code" href="class_interface_entry.html#a6">networkLayerGateIndex</a>();
00258 
00259     <a class="code" href="class_m_p_l_s.html#d6">doStackOps</a>(mplsPacket, outLabel);
00260 
00261     <span class="keywordflow">if</span> (mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a7">hasLabel</a>())
00262     {
00263         <span class="comment">// forward labeled packet</span>
00264 
00265         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"forwarding packet to "</span> &lt;&lt; outInterface &lt;&lt; endl;
00266 
00267         <span class="keywordflow">if</span> (mplsPacket-&gt;hasPar(<span class="stringliteral">"color"</span>))
00268         {
00269             mplsPacket-&gt;par(<span class="stringliteral">"color"</span>) = color;
00270         }
00271         <span class="keywordflow">else</span>
00272         {
00273             mplsPacket-&gt;addPar(<span class="stringliteral">"color"</span>) = color;
00274         }
00275 
00276         <span class="comment">//ASSERT(labelIf[outgoingPort]);</span>
00277 
00278         <a class="code" href="class_m_p_l_s.html#d5">sendToL2</a>(mplsPacket, outgoingPort);
00279     }
00280     <span class="keywordflow">else</span>
00281     {
00282         <span class="comment">// last label popped, decapsulate and send out IP datagram</span>
00283 
00284         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"decapsulating IP datagram"</span> &lt;&lt; endl;
00285 
00286         <a class="code" href="class_i_p_datagram.html">IPDatagram</a> *nativeIP = check_and_cast&lt;IPDatagram *&gt;(mplsPacket-&gt;decapsulate());
00287         <span class="keyword">delete</span> mplsPacket;
00288 
00289         <span class="keywordflow">if</span> (outgoingPort != -1)
00290         {
00291             <a class="code" href="class_m_p_l_s.html#d5">sendToL2</a>(nativeIP, outgoingPort);
00292         }
00293         <span class="keywordflow">else</span>
00294         {
00295             send(nativeIP, <span class="stringliteral">"netwOut"</span>, gateIndex);
00296         }
00297     }
00298 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d1" doxytag="MPLS::processPacketFromL2"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::processPacketFromL2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00197 {
00198     <a class="code" href="class_i_p_datagram.html">IPDatagram</a> *ipdatagram = dynamic_cast&lt;IPDatagram *&gt;(msg);
00199     <a class="code" href="class_m_p_l_s_packet.html">MPLSPacket</a> *mplsPacket = dynamic_cast&lt;MPLSPacket *&gt;(msg);
00200 
00201     <span class="keywordflow">if</span> (mplsPacket)
00202     {
00203         <a class="code" href="class_m_p_l_s.html#d2">processMPLSPacketFromL2</a>(mplsPacket);
00204     }
00205     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ipdatagram)
00206     {
00207         <span class="comment">// IP datagram arrives at Ingress router. We'll try to classify it</span>
00208         <span class="comment">// and add an MPLS header</span>
00209 
00210         <span class="keywordflow">if</span> (!<a class="code" href="class_m_p_l_s.html#d3">tryLabelAndForwardIPDatagram</a>(ipdatagram))
00211         {
00212             <span class="keywordtype">int</span> gateIndex = ipdatagram-&gt;arrivalGate()-&gt;index();
00213             send(ipdatagram, <span class="stringliteral">"netwOut"</span>, gateIndex);
00214         }
00215     }
00216     <span class="keywordflow">else</span>
00217     {
00218         error(<span class="stringliteral">"Unknown message received"</span>);
00219     }
00220 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d0" doxytag="MPLS::processPacketFromL3"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::processPacketFromL3           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00087 {
00088     <a class="code" href="class_i_p_datagram.html">IPDatagram</a> *ipdatagram = check_and_cast&lt;IPDatagram *&gt;(msg);
00089     <span class="comment">//int gateIndex = msg-&gt;arrivalGate()-&gt;index();</span>
00090 
00091     <span class="comment">// XXX temporary solution, until TCPSocket and IP are extended to support nam tracing</span>
00092     <span class="keywordflow">if</span> (ipdatagram-&gt;<a class="code" href="class_i_p_datagram.html#a17">transportProtocol</a>() == <a class="code" href="_i_p_protocol_id__m_8h.html#a23a4">IP_PROT_TCP</a>)
00093     {
00094         <a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *seg = check_and_cast&lt;TCPSegment*&gt;(ipdatagram-&gt;encapsulatedMsg());
00095         <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a6">destPort</a>() == <a class="code" href="_l_d_p_8h.html#a0">LDP_PORT</a> || seg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a4">srcPort</a>() == <a class="code" href="_l_d_p_8h.html#a0">LDP_PORT</a>)
00096         {
00097             ASSERT(!ipdatagram-&gt;hasPar(<span class="stringliteral">"color"</span>));
00098             ipdatagram-&gt;addPar(<span class="stringliteral">"color"</span>) = <a class="code" href="_l_d_p_8h.html#a1">LDP_TRAFFIC</a>;
00099         }
00100     }
00101     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ipdatagram-&gt;<a class="code" href="class_i_p_datagram.html#a17">transportProtocol</a>() == <a class="code" href="_i_p_protocol_id__m_8h.html#a23a1">IP_PROT_ICMP</a>)
00102     {
00103         <span class="comment">// ASSERT(!ipdatagram-&gt;hasPar("color")); XXX this did not hold sometimes...</span>
00104         <span class="keywordflow">if</span> (!ipdatagram-&gt;hasPar(<span class="stringliteral">"color"</span>))
00105             ipdatagram-&gt;addPar(<span class="stringliteral">"color"</span>) = <a class="code" href="_m_p_l_s_8cc.html#a0">ICMP_TRAFFIC</a>;
00106     }
00107     <span class="comment">// XXX end of temporary area</span>
00108 
00109     <a class="code" href="class_m_p_l_s.html#d4">labelAndForwardIPDatagram</a>(ipdatagram);
00110 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d5" doxytag="MPLS::sendToL2"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void MPLS::sendToL2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cMessage *&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>gateIndex</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00082 {
00083     send(msg, <span class="stringliteral">"ifOut"</span>, gateIndex);
00084 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="d3" doxytag="MPLS::tryLabelAndForwardIPDatagram"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">bool MPLS::tryLabelAndForwardIPDatagram           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_i_p_datagram.html">IPDatagram</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ipdatagram</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [private]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00113 {
00114     <a class="code" href="_l_i_b_table_8h.html#a3">LabelOpVector</a> outLabel;
00115     std::string outInterface;
00116     <span class="keywordtype">int</span> color;
00117 
00118     <span class="keywordflow">if</span> (!<a class="code" href="class_m_p_l_s.html#r3">pct</a>-&gt;<a class="code" href="class_i_classifier.html#a1">lookupLabel</a>(ipdatagram, outLabel, outInterface, color))
00119     {
00120         <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"no mapping exists for this packet"</span> &lt;&lt; endl;
00121         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00122     }
00123 
00124     ASSERT(outLabel.size() &gt; 0);
00125 
00126     <span class="keywordtype">int</span> outgoingPort = <a class="code" href="class_m_p_l_s.html#r2">ift</a>-&gt;<a class="code" href="class_interface_table.html#a9">interfaceByName</a>(outInterface.c_str())-&gt;<a class="code" href="class_interface_entry.html#a6">networkLayerGateIndex</a>();
00127 
00128     <a class="code" href="class_m_p_l_s_packet.html">MPLSPacket</a> *mplsPacket = <span class="keyword">new</span> <a class="code" href="class_m_p_l_s_packet.html">MPLSPacket</a>(ipdatagram-&gt;name());
00129     mplsPacket-&gt;encapsulate(ipdatagram);
00130     <a class="code" href="class_m_p_l_s.html#d6">doStackOps</a>(mplsPacket, outLabel);
00131 
00132     <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"forwarding packet to "</span> &lt;&lt; outInterface &lt;&lt; endl;
00133 
00134     mplsPacket-&gt;addPar(<span class="stringliteral">"color"</span>) = color;
00135 
00136     <span class="keywordflow">if</span> (!mplsPacket-&gt;<a class="code" href="class_m_p_l_s_packet.html#a7">hasLabel</a>())
00137     {
00138         <span class="comment">// yes, this may happen - if we'are both ingress and egress</span>
00139         ipdatagram = check_and_cast&lt;IPDatagram*&gt;(mplsPacket-&gt;decapsulate()); <span class="comment">// XXX FIXME superfluous encaps/decaps</span>
00140         <span class="keyword">delete</span> mplsPacket;
00141         <a class="code" href="class_m_p_l_s.html#d5">sendToL2</a>(ipdatagram, outgoingPort);
00142     }
00143     <span class="keywordflow">else</span>
00144         <a class="code" href="class_m_p_l_s.html#d5">sendToL2</a>(mplsPacket, outgoingPort);
00145 
00146     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00147 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Data Documentation</h2>
<a class="anchor" name="r0" doxytag="MPLS::delay1"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">simtime_t <a class="el" href="class_m_p_l_s.html#r0">MPLS::delay1</a><code> [private]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="r2" doxytag="MPLS::ift"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_interface_table.html">InterfaceTable</a>* <a class="el" href="class_m_p_l_s.html#r2">MPLS::ift</a><code> [private]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="r1" doxytag="MPLS::lt"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_l_i_b_table.html">LIBTable</a>* <a class="el" href="class_m_p_l_s.html#r1">MPLS::lt</a><code> [private]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="r3" doxytag="MPLS::pct"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"><a class="el" href="class_i_classifier.html">IClassifier</a>* <a class="el" href="class_m_p_l_s.html#r3">MPLS::pct</a><code> [private]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_m_p_l_s_8h.html">MPLS.h</a><li><a class="el" href="_m_p_l_s_8cc.html">MPLS.cc</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 18:22:27 2006 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.0 </small></address>
</body>
</html>
