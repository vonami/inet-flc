<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>INET Framework for OMNeT++/OMNEST: ICMPSerializer Class Reference</title>
<link href="opp.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.0 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ICMPSerializer Class Reference</h1><code>#include &lt;ICMPSerializer.h&gt;</code>
<p>
<a href="class_i_c_m_p_serializer-members.html">List of all members.</a><hr><a name="_details"></a><h2>Detailed Description</h2>
Converts between <a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a> and binary (network byte order) <a class="el" href="class_i_c_m_p.html">ICMP</a> header. 
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_i_c_m_p_serializer.html#a0">ICMPSerializer</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_i_c_m_p_serializer.html#a1">serialize</a> (<a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a> *pkt, unsigned char *buf, unsigned int bufsize)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_i_c_m_p_serializer.html#a2">parse</a> (unsigned char *buf, unsigned int bufsize, <a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a> *pkt)</td></tr>

<tr><td colspan="2"><br><h2>Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static unsigned short&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_i_c_m_p_serializer.html#e0">checksum</a> (unsigned char *addr, unsigned int count)</td></tr>

</table>
<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="a0" doxytag="ICMPSerializer::ICMPSerializer"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">ICMPSerializer::ICMPSerializer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<div class="fragment"><pre class="fragment">00032 {}
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="e0" doxytag="ICMPSerializer::checksum"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">unsigned short ICMPSerializer::checksum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>addr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned int&nbsp;</td>
          <td class="mdname" nowrap> <em>count</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Helper: calculate checksum <div class="fragment"><pre class="fragment">00154 {
00155     <span class="keywordtype">long</span> sum = 0;
00156 
00157     <span class="keywordflow">while</span> (count &gt; 1)  {
00158         sum += *((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *&amp;)addr)++;
00159         <span class="keywordflow">if</span> (sum &amp; 0x80000000)
00160             sum = (sum &amp; 0xFFFF) + (sum &gt;&gt; 16);
00161         count -= 2;
00162     }
00163 
00164     if (count)
00165         sum += *(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)addr;
00166 
00167     while (sum &gt;&gt; 16)
00168         sum = (sum &amp; 0xffff) + (sum &gt;&gt; 16);
00169 
00170     return ~sum;
00171 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ICMPSerializer::parse"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">void ICMPSerializer::parse           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned int&nbsp;</td>
          <td class="mdname" nowrap> <em>bufsize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap><a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pkt</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Puts a packet sniffed from the wire into an <a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a>. <div class="fragment"><pre class="fragment">00103 {
00104     <span class="keyword">struct </span><a class="code" href="struct_i_n_e_t_fw_1_1icmp.html">icmp</a> *<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html">icmp</a> = (<span class="keyword">struct </span>icmp*) buf;
00105 
00106     <span class="keywordflow">switch</span>(icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o0">icmp_type</a>)
00107     {
00108         <span class="keywordflow">case</span> <a class="code" href="ip__icmp_8h.html#a45">ICMP_ECHO</a>:
00109         {
00110             <a class="code" href="class_ping_payload.html">PingPayload</a> *pp;
00111             <span class="keywordtype">char</span> name[32];
00112 
00113             pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a8">setType</a>(ICMP_ECHO_REQUEST);
00114             pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a10">setCode</a>(0);
00115             pkt-&gt;setByteLength(4);
00116             sprintf(name,<span class="stringliteral">"ping%d"</span>, ntohs(icmp-&gt;icmp_seq));
00117             pp = <span class="keyword">new</span> <a class="code" href="class_ping_payload.html">PingPayload</a>(name);
00118             pp-&gt;<a class="code" href="class_ping_payload.html#a8">setOriginatorId</a>(ntohs(icmp-&gt;icmp_id));
00119             pp-&gt;<a class="code" href="class_ping_payload.html#a10">setSeqNo</a>(ntohs(icmp-&gt;icmp_seq));
00120             pp-&gt;setByteLength(bufsize - 4);
00121             pp-&gt;<a class="code" href="class_ping_payload.html#a11">setDataArraySize</a>(bufsize - ICMP_MINLEN);
00122             <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;bufsize - <a class="code" href="ip__icmp_8h.html#a17">ICMP_MINLEN</a>; i++)
00123                 pp-&gt;<a class="code" href="class_ping_payload.html#a14">setData</a>(i, icmp-&gt;icmp_data[i]);
00124             pkt-&gt;encapsulate(pp);
00125             pkt-&gt;setName(pp-&gt;name());
00126             <span class="keywordflow">break</span>;
00127         }
00128         <span class="keywordflow">case</span> <a class="code" href="ip__icmp_8h.html#a22">ICMP_ECHOREPLY</a>:
00129         {
00130             <a class="code" href="class_ping_payload.html">PingPayload</a> *pp;
00131             <span class="keywordtype">char</span> name[32];
00132 
00133             pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a8">setType</a>(ICMP_ECHO_REPLY);
00134             pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a10">setCode</a>(0);
00135             pkt-&gt;setByteLength(4);
00136             sprintf(name,<span class="stringliteral">"ping%d-reply"</span>, ntohs(icmp-&gt;icmp_seq));
00137             pp = <span class="keyword">new</span> <a class="code" href="class_ping_payload.html">PingPayload</a>(name);
00138             pp-&gt;<a class="code" href="class_ping_payload.html#a8">setOriginatorId</a>(ntohs(icmp-&gt;icmp_id));
00139             pp-&gt;<a class="code" href="class_ping_payload.html#a10">setSeqNo</a>(ntohs(icmp-&gt;icmp_seq));
00140             pp-&gt;setByteLength(bufsize - 4);
00141             pkt-&gt;encapsulate(pp);
00142             pkt-&gt;setName(pp-&gt;name());
00143             <span class="keywordflow">break</span>;
00144         }
00145         <span class="keywordflow">default</span>:
00146         {
00147             <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"Can not create ICMP packet: type "</span> &lt;&lt; icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o0">icmp_type</a> &lt;&lt; <span class="stringliteral">" not supported."</span>;
00148             <span class="keywordflow">break</span>;
00149         }
00150     }
00151 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ICMPSerializer::serialize"></a><p>
<table class="mdTable" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top">int ICMPSerializer::serialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pkt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned char *&nbsp;</td>
          <td class="mdname" nowrap> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td class="md"></td>
          <td class="md" nowrap>unsigned int&nbsp;</td>
          <td class="mdname" nowrap> <em>bufsize</em></td>
        </tr>
        <tr>
          <td class="md"></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing="5" cellpadding="0" border="0">
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Serializes an <a class="el" href="class_i_c_m_p_message.html">ICMPMessage</a> for transmission on the wire. Returns the length of data written into buffer. <div class="fragment"><pre class="fragment">00041 {
00042     <span class="keyword">struct </span><a class="code" href="struct_i_n_e_t_fw_1_1icmp.html">icmp</a> *<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html">icmp</a> = (<span class="keyword">struct </span>icmp *) (buf);
00043     <span class="keywordtype">int</span> packetLength;
00044 
00045     packetLength = <a class="code" href="ip__icmp_8h.html#a17">ICMP_MINLEN</a>;
00046 
00047     <span class="keywordflow">switch</span>(pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a7">getType</a>())
00048     {
00049         <span class="keywordflow">case</span> <a class="code" href="_i_c_m_p_message__m_8h.html#a30a23">ICMP_ECHO_REQUEST</a>:
00050         {
00051             <a class="code" href="class_ping_payload.html">PingPayload</a> *pp = check_and_cast&lt;PingPayload* &gt;(pkt-&gt;encapsulatedMsg());
00052             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o0">icmp_type</a> = <a class="code" href="ip__icmp_8h.html#a45">ICMP_ECHO</a>;
00053             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o1">icmp_code</a> = 0;
00054             icmp-&gt;icmp_id   = htons(pp-&gt;<a class="code" href="class_ping_payload.html#a7">originatorId</a>());
00055             icmp-&gt;icmp_seq  = htons(pp-&gt;<a class="code" href="class_ping_payload.html#a9">seqNo</a>());
00056             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> datalen = (pp-&gt;byteLength() - 4);
00057             <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; datalen; i++)
00058                 icmp-&gt;icmp_data[i] = <span class="charliteral">'a'</span>;
00059             packetLength += datalen;
00060             <span class="keywordflow">break</span>;
00061         }
00062         <span class="keywordflow">case</span> <a class="code" href="_i_c_m_p_message__m_8h.html#a30a24">ICMP_ECHO_REPLY</a>:
00063         {
00064             <a class="code" href="class_ping_payload.html">PingPayload</a> *pp = check_and_cast&lt;PingPayload* &gt;(pkt-&gt;encapsulatedMsg());
00065             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o0">icmp_type</a> = <a class="code" href="ip__icmp_8h.html#a22">ICMP_ECHOREPLY</a>;
00066             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o1">icmp_code</a> = 0;
00067             icmp-&gt;icmp_id   = htons(pp-&gt;<a class="code" href="class_ping_payload.html#a7">originatorId</a>());
00068             icmp-&gt;icmp_seq  = htons(pp-&gt;<a class="code" href="class_ping_payload.html#a9">seqNo</a>());
00069             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> datalen = pp-&gt;<a class="code" href="class_ping_payload.html#a12">dataArraySize</a>();
00070             <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; datalen; i++)
00071                 icmp-&gt;icmp_data[i] = pp-&gt;<a class="code" href="class_ping_payload.html#a13">data</a>(i);
00072             packetLength += datalen;
00073             <span class="keywordflow">break</span>;
00074         }
00075         <span class="keywordflow">case</span> <a class="code" href="_i_c_m_p_message__m_8h.html#a30a19">ICMP_DESTINATION_UNREACHABLE</a>:
00076         {
00077             <a class="code" href="class_i_p_datagram.html">IPDatagram</a> *<a class="code" href="struct_i_n_e_t_fw_1_1ip.html">ip</a> = check_and_cast&lt;IPDatagram* &gt;(pkt-&gt;encapsulatedMsg());
00078             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o0">icmp_type</a> = <a class="code" href="ip__icmp_8h.html#a23">ICMP_UNREACH</a>;
00079             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o1">icmp_code</a> = pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a9">getCode</a>();
00080             packetLength += <a class="code" href="class_i_p_serializer.html">IPSerializer</a>().serialize(ip, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)icmp-&gt;icmp_data, bufsize - ICMP_MINLEN);
00081             <span class="keywordflow">break</span>;
00082         }
00083         <span class="keywordflow">case</span> <a class="code" href="_i_c_m_p_message__m_8h.html#a30a21">ICMP_TIME_EXCEEDED</a>:
00084         {
00085             <a class="code" href="class_i_p_datagram.html">IPDatagram</a> *ip = check_and_cast&lt;IPDatagram* &gt;(pkt-&gt;encapsulatedMsg());
00086             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o0">icmp_type</a> = <a class="code" href="ip__icmp_8h.html#a48">ICMP_TIMXCEED</a>;
00087             icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o1">icmp_code</a> = <a class="code" href="ip__icmp_8h.html#a49">ICMP_TIMXCEED_INTRANS</a>;
00088             packetLength += <a class="code" href="class_i_p_serializer.html">IPSerializer</a>().serialize(ip, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)icmp-&gt;icmp_data, bufsize - ICMP_MINLEN);
00089             <span class="keywordflow">break</span>;
00090         }
00091         <span class="keywordflow">default</span>:
00092         {
00093             packetLength = 0;
00094             <a class="code" href="_i_n_e_t_defs_8h.html#a1">EV</a> &lt;&lt; <span class="stringliteral">"Can not serialize ICMP packet: type "</span> &lt;&lt; pkt-&gt;<a class="code" href="class_i_c_m_p_message.html#a7">getType</a>() &lt;&lt; <span class="stringliteral">" not supported."</span>;
00095             <span class="keywordflow">break</span>;
00096         }
00097     }
00098     icmp-&gt;<a class="code" href="struct_i_n_e_t_fw_1_1icmp.html#o2">icmp_cksum</a> = <a class="code" href="class_i_c_m_p_serializer.html#e0">checksum</a>(buf, packetLength);
00099     <span class="keywordflow">return</span> packetLength;
00100 }
</pre></div>
<p>
    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_i_c_m_p_serializer_8h.html">ICMPSerializer.h</a><li><a class="el" href="_i_c_m_p_serializer_8cc.html">ICMPSerializer.cc</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 18:22:22 2006 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.0 </small></address>
</body>
</html>
